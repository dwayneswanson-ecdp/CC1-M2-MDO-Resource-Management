<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google" content="notranslate">
  <meta http-equiv="Content-Language" content="en">
  <meta name="robots" content="no-translate">
  <title>CC - English -</title>

  <!-- Quill CSS -->
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">

  <style>
    /* Anti-copy / anti-translate behaviour ‚Äì leave as is for exam security */
    html, body {
      translate: none !important;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      margin: 0;
      padding: 0;
    }
    * { translate: none !important; }

  
    /* Global body */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, Helvetica, sans-serif;
      background: #f5f7fb;
      color: #222;
      font-size: 16px;
      line-height: 1.6;
      padding-top: 90px; /* space for fixed header (adjust if needed) */
    }

    /* Fixed exam header ‚Äì now visually closer to the new site navbar */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;

      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;

      background: #ffffffcc;              /* light, slightly transparent */
      backdrop-filter: blur(10px);
      color: #111827;
      padding: 14px 24px;
      border-bottom: 1px solid #e1e4f0;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.04);
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
      letter-spacing: 0.03em;
      font-weight: 700;
      color: #2643e9; /* same blue accent as the new page */
    }

 /* Timer on the right */
#timer {
  font-weight: 700;
  font-size: 1.05rem;
  text-align: right;
  padding: 8px 18px;
  border-radius: 999px;
  border: 1px solid #111827;
  background: #111827;   /* dark pill */
  color: #f9fafb;        /* light text */
  white-space: nowrap;
  box-shadow: 0 1px 3px rgba(15, 23, 42, 0.25);
}

    /* Main exam wrapper */
    main {
      max-width: 900px;
      margin: 24px auto 40px;
      background: #ffffff;
      padding: 32px 32px 40px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
    }

    /* Reusable inner cards (e.g. intro screen, confirmation, parts) */
    .card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(15, 23, 42, 0.06);
      padding: 28px 28px 32px;
      max-width: 640px;
      margin: 32px auto;
      text-align: left;
      border: 1px solid #e5e7eb;
    }

    .card h2 {
      color: #111827;
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
    }

    label {
      display: block;
      margin: 12px 0 8px;
      font-weight: bold;
      font-size: 0.95rem;
      color: #111827;
    }

    input[type="text"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      box-sizing: border-box;
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    select {
      white-space: normal;
      word-wrap: break-word;
      padding: 8px;
      background: #ffffff;
    }

    button {
      background: #2643e9;
      color: #fff;
      border: none;
      padding: 10px 24px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      font-family: inherit;
    }
    button:hover {
      filter: brightness(0.96);
    }

    .btn-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .btn-row.center { justify-content: center; }
    .btn-row.right { justify-content: flex-end; }

    .btn-light {
      background: #eef2ff;
      color: #2643e9;
      border: 1px solid #c7d2fe;
    }
    .btn-light:hover {
      background: #e0e7ff;
    }

    ol {
      padding-left: 20px;
    }
    ol li {
      margin-bottom: 14px;
      font-size: 0.95rem;
    }

    /* STEP / PART VISIBILITY ‚Äì functional: do NOT change selectors */
    #exam,
    #confirm,
    #partA,
    #partB {
      display: none;
    }
    #partA.active,
    #partB.active {
      display: block;
    }

    /* Quill editor container ‚Äì visually aligned with card style */
    .editor-card {
      border: 1px solid #e3e6ee;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
      margin-top: 12px;
    }

    .ql-toolbar.ql-snow {
      border: none;
      border-bottom: 1px solid #e3e6ee;
      background: #f9fbff;
    }

    .ql-container.ql-snow {
      border: none;
      min-height: 260px;
      background: #ffffff;
    }

    .ql-editor {
      min-height: 240px;
      font-size: 0.95rem;
    }

    .muted {
      color: #6b7280;
      font-size: 0.9rem;
    }

    /* Name row layout */
    .name-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .name-row .field {
      flex: 1 1 0;
    }

    /* Visually force uppercase display on last name */
    .upper {
      text-transform: uppercase;
    }

    /* === Part A ‚Äì Vocabulary Matching layout === */
    #partA h2 {
      text-align: left;
      margin-bottom: 0.5rem;
    }

    .partA-intro {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 1.25rem;
    }

    /* Each line = grid: term on the left, dropdown on the right */
    #partA ol {
      margin: 0;
      padding-left: 1.5rem; /* keeps automatic numbering */
    }

    /* Underline each vocab row with a faint separator */
#partA ol li {
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 12px;
  margin-bottom: 12px;
}
#partA ol li:last-child {
  border-bottom: none;
}

/* Small preview of the full selected definition */
.definition-preview {
  margin-top: 4px;
  font-size: 0.85rem;
  color: #6b7280;
}

    .vocab-row {
      display: grid;
      grid-template-columns: minmax(0, 0.7fr) minmax(0, 1.3fr);
      column-gap: 18px;
      align-items: center;
    }

    .vocab-term {
      font-size: 0.95rem;
      color: #111827;
      font-weight: 500;
    }

    .vocab-select {
      margin: 0;
    }

    /* Blur background when exit warning is active ‚Äì GLOBAL (all screen sizes) */
    body.exit-lock {
      overflow: hidden;
    }
    body.exit-lock header,
    body.exit-lock main {
      filter: blur(6px);
      pointer-events: none;
    }

    body.overlay-active main,
    body.overlay-active header {
      filter: blur(5px);
      pointer-events: none;
    }

    body.overlay-active {
      overflow: hidden;
    }

    /* On mobile, stack term + select */
    @media (max-width: 720px) {
      .vocab-row {
        grid-template-columns: 1fr;
        row-gap: 6px;
      }
    }

    /* Responsive tweaks */
    @media (max-width: 720px) {
      body {
        padding-top: 100px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        padding-inline: 16px;
      }

      #timer {
        align-self: flex-end;
      }

      main {
        margin: 16px auto 32px;
        padding: 24px 16px 32px;
        border-radius: 12px;
      }

      .card {
        margin: 24px auto;
        padding: 20px 18px 24px;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1 id="examTitleHeader">CC1 - English ‚Äî Resource Management</h1>
    <div id="timer"></div>
  </header>

  <main>
    <span id="langSentinel" style="display:none;">
  This reference sentence is used only to detect automatic translation of the exam page.
</span>
    
    <!-- LOGIN -->
    <section id="login" class="card">
      <h2>Commencer l'√©preuve</h2>
      <p>Merci de renseigner vos informations pour commencer. Une fois l‚Äô√©preuve lanc√©e, vous disposerez de <b>60 minutes</b> pour la compl√©ter.</p>

      <label>Nom et pr√©nom :</label>
      <div class="name-row">
        <div class="field">
          <input type="text" id="studentLastName" class="upper" placeholder="NOM (en majuscules)" required>
        </div>
        <div class="field">
          <input type="text" id="studentFirstName" placeholder="Pr√©nom" required>
        </div>
      </div>

      <label>Adresse e-mail :</label>
      <input type="email" id="studentEmail" required>

      <label>Groupe :</label>
      <select id="groupSelect" required>
        <option value="">S√©lectionner votre groupe</option>
        <option value="M2 MDO G1">M2 MDO G1</option>
        <option value="M2 MDO G2">M2 MDO G2</option>
        <option value="M2 MDO G3">M2 MDO G3</option>
      </select>

      <label>Code de classe :</label>
      <input type="text" id="classCode" required>

      <div class="btn-row center">
        <button id="startBtn" type="button">Commencer</button>
      </div>
    </section>

    <!-- CONFIRM -->
    <section id="confirm" class="card">
      <h2>Avant de commencer l‚Äô√©preuve</h2>

      <p class="muted"><strong>Comment fonctionne l‚Äô√©preuve&nbsp;?</strong></p>
      <ul class="muted">
        <li>L‚Äô√©preuve se d√©roule en <strong>plein √©cran</strong>.</li>
        <li>Si vous quittez la fen√™tre ou changez d‚Äôapplication, un <strong>message d‚Äôavertissement</strong> appara√Æt.</li>
        <li>Vous avez <strong>15&nbsp;secondes</strong> pour revenir, sinon l‚Äô√©preuve est arr√™t√©e et devra √™tre recommenc√©e.</li>
        <li>Apr√®s <strong>3 √©v√®nements techniques</strong> (sortie du plein √©cran, changement de fen√™tre, etc.), l‚Äô√©preuve est <strong>envoy√©e automatiquement</strong> √† l‚Äôenseignant.</li>
        <li>Tous ces √©v√®nements sont enregistr√©s dans un <strong>r√©capitulatif technique de session</strong> joint √† votre copie.</li>
      </ul>

      <hr style="margin:18px 0; border:none; border-top:1px solid #e5e7eb;">

      <p class="muted"><strong>V√©rifiez vos informations</strong></p>
      <p><b>Nom &amp; pr√©nom :</b> <span id="confirmName"></span></p>
      <p><b>Email :</b> <span id="confirmEmail"></span></p>
      <p><b>Groupe :</b> <span id="confirmGroup"></span></p>
      <p class="muted">
        Si quelque chose n‚Äôest pas correct, cliquez sur ¬´&nbsp;Modifier&nbsp;¬ª pour revenir √† l‚Äô√©cran pr√©c√©dent.
      </p>

      <div class="btn-row">
        <button type="button" class="btn-light" id="confirmBackBtn">‚Üê Modifier</button>
        <button type="button" id="confirmBeginBtn">Commencer l'√©preuve ‚Üí</button>
      </div>
    </section>

    <!-- EXAM -->
    <section id="exam">
      <form id="examForm">
        <input type="hidden" name="studentName" id="studentNameField">
        <input type="hidden" name="studentEmail" id="studentEmailField">
        <input type="hidden" name="classCode" id="classCodeField">
        <input type="hidden" name="groupName" id="groupNameField">

        <!-- PART A -->
        <div id="partA" class="active">
          <h2>Part A ‚Äì Vocabulary Matching</h2>
          <p class="partA-intro">
            Match each term with the correct definition by selecting an option in the dropdown list.
          </p>

          <ol>
            <li>
              <div class="vocab-row">
                <span class="vocab-term">Budget</span>
                <select name="q1" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                 <div class="definition-preview" data-for="q1"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Forecast</span>
                <select name="q2" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                 <div class="definition-preview" data-for="q2"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">KPI (Key Performance Indicator)</span>
                <select name="q3" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                 <div class="definition-preview" data-for="q3"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Supplier</span>
                <select name="q4" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                 <div class="definition-preview" data-for="q4"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Headcount</span>
                <select name="q5" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                 <div class="definition-preview" data-for="q5"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Lead time</span>
                <select name="q6" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                 <div class="definition-preview" data-for="q6"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Inventory</span>
                <select name="q7" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                 <div class="definition-preview" data-for="q7"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Overhead</span>
                <select name="q8" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                 <div class="definition-preview" data-for="q8"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Sustainability</span>
                <select name="q9" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                 <div class="definition-preview" data-for="q9"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">ROI (Return on Investment)</span>
                <select name="q10" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                 <div class="definition-preview" data-for="q10"></div>
              </div>
            </li>
          </ol>

          <div class="btn-row right">
            <button type="button" id="toPartB">Suivant ‚Üí Part B</button>
          </div>
        </div>

        <!-- PART B -->
        <div id="partB">
          <h2>Part B ‚Äì Writing: Email to Your Manager</h2>

          <p class="muted"><strong>Context</strong></p>
          <p class="muted">
            You work for an emerging sports brand. In a meeting, we discussed the business strategy of the
            sportswear brand <em>On</em>, and how it uses its resources to support growth and stay competitive
            (planning, costs, suppliers, customers, etc.). Your manager did not attend the presentation but
            wants to understand what you learned and how it could help the company.
          </p>

          <p class="muted"><strong>Task</strong></p>
          <ul class="muted">
            <li>Explain how On is managing its resources (in your own words).</li>
            <li>Analyse why this approach is important for long-term performance.</li>
            <li>Suggest 1‚Äì2 concrete actions a sportswear company could take to improve its strategy.</li>
          </ul>

          <p class="muted"><strong>Requirements</strong></p>
          <ul class="muted">
            <li>Use at least THREE (3) words from the vocabulary discussed in class.</li>
            <li>
              Include a clear email structure:
              subject line, short introduction, development, conclusion, and 
              appropriate sign-off.
            </li>
            <li>Use formal, professional language.</li>
            <li>Write a coherent, well-organised email.</li>
          </ul>

          <div class="editor-card">
            <div id="editor"></div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-light" id="toPartA">‚Üê Retour √† la partie A</button>
            <button type="submit">Envoyer l'√©preuve</button>
          </div>
        </div>
      </form>
    </section>
  </main>

  <!-- Exit warning overlay -->
  <div id="exitOverlay" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.80);
    backdrop-filter:blur(6px);
    z-index:2000;
    align-items:center;
    justify-content:center;
  ">
    <div style="
      background:#ffffff;
      max-width:420px;
      width:90%;
      border-radius:16px;
      padding:20px 22px 18px;
      box-shadow:0 18px 45px rgba(15,23,42,0.25);
      font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    ">
      <h2 style="margin:0 0 8px 0; font-size:1rem; color:#111827;">
        Quitter l‚Äô√©preuve ?
      </h2>
          <div id="exitOverlayStrike" style="
      margin:4px 0 6px 0;
      font-size:1.5rem;
      font-weight:700;
      color:#b91c1c;
      letter-spacing:0.06em;
      text-transform:uppercase;
      text-align:left;
    ">
      <!-- Filled dynamically, e.g. AVERTISSEMENT 1 / 2 -->
    </div>
      <p id="exitOverlayMessage" style="margin:0 0 8px 0; font-size:0.9rem; color:#4b5563;">
        Vous √™tes sur le point de quitter l‚Äô√©cran de l‚Äô√©preuve.
        Si vous continuez, votre √©preuve sera effac√©e.
      </p>

      <!-- NEW: countdown text + big digits -->
      <p id="exitOverlayCountdownText" style="margin:0 0 4px 0; font-size:0.9rem; color:#6b7280; text-align:center;">
        Vous avez 15&nbsp;secondes pour rester dans l‚Äô√©preuve avant qu‚Äôelle ne soit interrompue.
      </p>
      <div id="exitOverlayCountdownDigits" style="
        font-size:2.6rem;
        font-weight:700;
        text-align:center;
        margin:0 0 16px 0;
        color:#111827;
      ">
        15
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:8px;">
        <button type="button" id="exitOverlayStay" style="
          padding:8px 16px;
          border-radius:999px;
          border:1px solid #c7d2fe;
          background:#eef2ff;
          color:#2643e9;
          font-size:0.9rem;
          font-weight:600;
          cursor:pointer;
        ">
          Rester dans l‚Äô√©preuve
        </button>
        <button type="button" id="exitOverlayLeave" style="
          padding:8px 16px;
          border-radius:999px;
          border:none;
          background:#b91c1c;
          color:#fff;
          font-size:0.9rem;
          font-weight:600;
          cursor:pointer;
        ">
          Quitter et effacer
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

  <script>
    // ----- Global configuration for this exam -----
    const EXAM_CONFIG = {
      examId: "M2MD_CC1_2025",
      classCode: "BLANK",        // <-- put real code here before exam
      debugCode: "DEBUG",
      examTitleBase: "CC1 - English ‚Äî Resource Management",
      allowedGroups: ["M2 MDO G1", "M2 MDO G2", "M2 MDO G3"],
      timeLimitMinutes: 60,
      emailSubjectTemplate: "(NAME) CC1 - English - (GROUP)",
      classLabel: "M2MDOG"
    };

    const DEADLINE_KEY = "examDeadline_" + EXAM_CONFIG.examId;
    let examDeadline = null;
    let timer = null;
    let quill = null;
    let isMobile = false;       // set inside DOMContentLoaded
    let safeBlurUntil = 0;

    // NEW: anti-cheat counters + countdown
     let violationCount = 0;
  const MAX_VIOLATIONS = 3;         // 3rd event = auto-submit
  const MAX_WARNINGS = MAX_VIOLATIONS - 1; // 1 and 2 show popup
  let exitCountdownTimer = null;
  let exitSecondsRemaining = 0;

    let selectedGroup = "";
    let currentExamTitle = EXAM_CONFIG.examTitleBase;

    function armSafeBlur(ms = 1200) {
      safeBlurUntil = Date.now() + ms;
    }

    // Restore deadline ONLY if still valid
    (function restoreDeadline() {
      const stored = localStorage.getItem(DEADLINE_KEY);
      if (!stored) return;
      const parsed = parseInt(stored, 10);
      if (!Number.isNaN(parsed) && parsed > Date.now()) {
        examDeadline = parsed;
        console.log("‚è± Restored valid examDeadline:", new Date(examDeadline).toISOString());
      } else {
        console.log("‚è± Stored examDeadline expired/invalid ‚Üí clearing.");
        localStorage.removeItem(DEADLINE_KEY);
      }
    })();

    // Correct answers + word list (Part A)
    const correctAnswers = {
      q1: "A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.",
      q2: "A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.",
      q3: "A measurable value that shows how effectively a company or team is achieving an important business objective.",
      q4: "A company or person that provides goods or services to another company, usually as part of a commercial contract.",
      q5: "The total number of employees working in an organisation, department, or team.",
      q6: "The time between placing an order and receiving the product or service, including production and delivery.",
      q7: "The stock of goods, materials, or products that a company holds for use in production or for sale to customers.",
      q8: "The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.",
      q9: "Doing business in a way that meets current needs without harming the environment, society, or future generations.",
      q10: "A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage."
    };

    const wordNames = [
      "Budget",
      "Forecast",
      "KPI (Key Performance Indicator)",
      "Supplier",
      "Headcount",
      "Lead time",
      "Inventory",
      "Overhead",
      "Sustainability",
      "ROI (Return on Investment)"
    ];

    // Create Quill lazily (only when Part B is shown)
    function ensureQuill() {
      if (quill) return;

      quill = new Quill("#editor", {
        theme: "snow",
        modules: {
          toolbar: [
            ["bold", "italic", "underline"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["clean"]
          ]
        }
      });

      const root = quill.root;

      // Arm safe blur when typing/tapping in editor (for iOS mobile blur bug)
      ["focus", "click", "keydown"].forEach(evt => {
        root.addEventListener(evt, () => {
          if (isMobile) armSafeBlur(1500);
        });
      });

      // Lock down copy/paste etc.
      root.addEventListener("contextmenu", e => e.preventDefault());
      root.addEventListener("paste", e => e.preventDefault());
      root.addEventListener("copy", e => e.preventDefault());
      root.addEventListener("cut", e => e.preventDefault());
      root.addEventListener("drop", e => e.preventDefault());
      root.addEventListener("keydown", e => {
        if ((e.ctrlKey || e.metaKey) && ["c", "v", "x", "a"].includes(e.key.toLowerCase())) {
          e.preventDefault();
        }
      });
    }

    // Randomise options but keep first option as "Select a definition"
    function randomizeSelectsKeepFirst() {
      document.querySelectorAll("#partA select").forEach(sel => {
        const opts = Array.from(sel.options);
        const first = opts.shift(); // first option = placeholder
        for (let i = opts.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [opts[i].text, opts[j].text] = [opts[j].text, opts[i].text];
        }
        sel.innerHTML = "";
        sel.appendChild(first);
        opts.forEach(o => sel.appendChild(o));
        sel.selectedIndex = 0;
      });
    }

function initDefinitionPreviews() {
  document.querySelectorAll('#partA select').forEach(sel => {
    const name = sel.name; // e.g. "q1"
    const preview = document.querySelector(
      `.definition-preview[data-for="${name}"]`
    );
    if (!preview) return;

    const update = () => {
      const opt = sel.options[sel.selectedIndex];
      const text = opt ? opt.text : "";

      // If it's the placeholder (first option), show nothing
      if (!opt || sel.selectedIndex === 0) {
        preview.textContent = "";
        sel.title = "";
        return;
      }

      // Otherwise, show the full definition under the dropdown
      preview.textContent = text;
      sel.title = text; // tooltip on hover (desktop)
    };

    sel.addEventListener("change", update);
    // Initial state
    update();
  });
}

    // Randomise question order in Part A
    function randomizeQuestionOrder() {
      const list = document.querySelector("#partA ol");
      if (!list) return;
      const items = Array.from(list.children);

      for (let i = items.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [items[i], items[j]] = [items[j], items[i]];
      }

      items.forEach(li => list.appendChild(li));
    }

    document.addEventListener("DOMContentLoaded", function() {
      // ---- User agent / device flags ----
      const ua = navigator.userAgent;
      const isIOSUA =
        /iPad|iPhone|iPod/.test(ua) ||
        (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

      isMobile = /Mobi|Android/i.test(ua) || isIOSUA;

      // Disable right-click everywhere on the page
document.addEventListener("contextmenu", function (e) {
  e.preventDefault();
}, { capture: true });

      // Detect Safari (desktop & iOS) ‚Äì block the exam on this browser
      const isSafari = /^((?!chrome|crios|fxios|android).)*safari/i.test(ua);

      if (isSafari) {
        const main = document.querySelector("main");
        if (main) {
          main.innerHTML = `
            <section class="card">
              <h2 style="display:flex; align-items:center; gap:8px; margin-top:0;">
                <span>‚ö†Ô∏è</span>
                <span>Navigateur non pris en charge</span>
              </h2>
              <p>
                Pour des raisons techniques, cette √©preuve en ligne n‚Äôest pas disponible sur
                <strong>Safari</strong>.
              </p>
              <p>
                Merci d‚Äôouvrir ce lien dans l‚Äôun des navigateurs suivants&nbsp;:
              </p>
              <ul>
                <li><strong>Google Chrome</strong></li>
                <li><strong>Microsoft Edge</strong></li>
                <li><strong>Mozilla Firefox</strong></li>
              </ul>
              <p class="muted">
                Si vous voyez encore ce message alors que vous utilisez d√©j√† l‚Äôun de ces navigateurs,
                merci d‚Äôen informer imm√©diatement votre enseignant.
              </p>
            </section>
          `;
        }

        const timerEl = document.getElementById("timer");
        if (timerEl) timerEl.textContent = "";
        return; // stop all further exam logic on Safari
      }

      // ----- EmailJS init -----
      if (window.emailjs) {
        try {
          emailjs.init({
            publicKey: "Bb0oPYBiZGQcyIz5r",
          });
        } catch (e) {
          console.error("EmailJS init error:", e);
        }
      }

      // ----- DOM Elements -----
      const login = document.getElementById("login");
      const confirmSec = document.getElementById("confirm");
      const exam = document.getElementById("exam");
      const titleHeader = document.getElementById("examTitleHeader");

      if (titleHeader) {
        titleHeader.textContent = EXAM_CONFIG.examTitleBase; // base without group
      }

      const startBtn = document.getElementById("startBtn");
      const confirmBackBtn = document.getElementById("confirmBackBtn");
      const confirmBeginBtn = document.getElementById("confirmBeginBtn");

      const confirmName = document.getElementById("confirmName");
      const confirmEmail = document.getElementById("confirmEmail");
      const confirmGroup = document.getElementById("confirmGroup");

      const partA = document.getElementById("partA");
      const partB = document.getElementById("partB");
      const toPartA = document.getElementById("toPartA");
      const toPartB = document.getElementById("toPartB");

      const timerDisplay = document.getElementById("timer");
      const form = document.getElementById("examForm");

      const studentFirstNameInput = document.getElementById("studentFirstName");
      const studentLastNameInput = document.getElementById("studentLastName");
      const studentEmailInput = document.getElementById("studentEmail");
      const classCodeInput = document.getElementById("classCode");
      const groupSelect = document.getElementById("groupSelect");

      const studentNameField = document.getElementById("studentNameField");
      const studentEmailField = document.getElementById("studentEmailField");
      const classCodeField = document.getElementById("classCodeField");
      const groupNameField = document.getElementById("groupNameField");

      // Exit overlay elements
      const exitOverlay = document.getElementById("exitOverlay");
      const exitOverlayMessage = document.getElementById("exitOverlayMessage");
      const exitOverlayStay = document.getElementById("exitOverlayStay");
      const exitOverlayLeave = document.getElementById("exitOverlayLeave");
      const exitOverlayCountdownText = document.getElementById("exitOverlayCountdownText");
      const exitOverlayCountdownDigits = document.getElementById("exitOverlayCountdownDigits");
    const exitOverlayStrike = document.getElementById("exitOverlayStrike");
      // Translation sentinel ‚Äì detects if the page text was auto-translated
const langSentinel = document.getElementById("langSentinel");
const langSentinelBaseline = langSentinel
  ? langSentinel.textContent.trim()
  : null;

if (langSentinel && langSentinelBaseline) {
  setInterval(() => {
    if (!examActive || examSubmitted) return;

    const current = langSentinel.textContent.trim();
    if (current !== langSentinelBaseline) {
      // Page text has been modified (likely translation)
      logEvent(
        "Possible page translation detected",
        `Sentinel changed from "${langSentinelBaseline}" to "${current}".`
      );

      askToExitExam(
        "Une modification automatique de la langue de la page a √©t√© d√©tect√©e. " +
        "Merci de d√©sactiver la traduction et de rester sur la version originale de l'√©preuve.",
        "translationWatch"
      );
    }
  }, 2000); // check every 2 seconds
}

      const submitBtn = form ? form.querySelector('button[type="submit"]') : null;

      // Safe-blur for Part A dropdowns (iOS bug)
      document.querySelectorAll("#partA select").forEach(sel => {
        sel.addEventListener("mousedown", () => {
          if (isMobile) armSafeBlur(1500);
        });
        sel.addEventListener("touchstart", () => {
          if (isMobile) armSafeBlur(2000);
        });
      });

      // -------- Session activity log --------
      const sessionEvents = [];

      function formatTimeStamp(date = new Date()) {
        try {
          return date.toLocaleTimeString("fr-FR", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
          });
        } catch (e) {
          return date.toISOString();
        }
      }

      function logEvent(label, detail) {
        const entry = {
          time: formatTimeStamp(),
          label: label || "",
          detail: detail || ""
        };
        sessionEvents.push(entry);
        console.log("[SESSION]", entry);
      }

      // Guard: if any required node is missing, stop
      const required = [
        login, confirmSec, exam, startBtn, confirmBackBtn, confirmBeginBtn,
        confirmName, confirmEmail, confirmGroup, partA, partB, toPartA, toPartB,
        timerDisplay, form, studentFirstNameInput, studentLastNameInput,
        studentEmailInput, classCodeInput, groupSelect
      ];
      if (required.some(n => !n)) {
        console.error("Missing required DOM nodes. Check IDs.", { required });
        return;
      }

      // ----- State Flags -----
      let examSubmitted = false;
      let examActive = false;
      let isStartingExam = false;
      let exitPromptOpen = false;
      let antiCheatSuspendedUntil = 0;   // grace window after "Rester"

      // Helper to visually lock/unlock background when overlay is active
      function setOverlayActive(active) {
        if (active) {
          document.body.classList.add("overlay-active", "exit-lock");
        } else {
          document.body.classList.remove("overlay-active", "exit-lock");
        }
      }

      // ----- Helpers -----
      function resetToLanding() {
        console.log("üîÑ resetToLanding called");

        try {
          clearInterval(timer);
        } catch (e) {
          console.error("Error clearing timer in resetToLanding:", e);
        }

        if (exitCountdownTimer) {
          clearInterval(exitCountdownTimer);
          exitCountdownTimer = null;
        }

        examActive = false;
        examSubmitted = false;
        isStartingExam = false;
        exitPromptOpen = false;
        antiCheatSuspendedUntil = 0;
        violationCount = 0;
        sessionEvents.length = 0;   // clear log
        setOverlayActive(false);

        if (form) form.reset();
        if (quill) quill.setText("");

        if (studentFirstNameInput) studentFirstNameInput.value = "";
        if (studentLastNameInput) studentLastNameInput.value = "";
        if (studentEmailInput) studentEmailInput.value = "";
        if (classCodeInput) classCodeInput.value = "";
        if (groupSelect) groupSelect.value = "";
        selectedGroup = "";
        currentExamTitle = EXAM_CONFIG.examTitleBase;

        if (titleHeader) {
          titleHeader.textContent = currentExamTitle;
        }

        login.style.display = "block";
        confirmSec.style.display = "none";
        exam.style.display = "none";

        if (exitOverlay) exitOverlay.style.display = "none";

        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Envoyer l'√©preuve";
        }

        console.log("‚úÖ Landing screen forced.");
      }

 function startTimer() {
  clearInterval(timer);
  timer = setInterval(() => {
    if (!examDeadline) return;
    const now = Date.now();
    const remainingMs = examDeadline - now;
    const totalSec = Math.max(0, Math.floor(remainingMs / 1000));
    const m = Math.floor(totalSec / 60);
    const s = totalSec % 60;

    if (timerDisplay) {
      timerDisplay.textContent = `Temps restant : ${m}:${s
        .toString()
        .padStart(2, "0")}`;

      // Neutral style above 5 minutes
      if (totalSec > 5 * 60) {
        timerDisplay.style.background = "#ffffff";
        timerDisplay.style.color = "#111827";
        timerDisplay.style.borderColor = "#4b5563";
      } else {
        // üî¥ Under 5 minutes: soft ‚Äúurgent‚Äù style
        timerDisplay.style.background = "#fee2e2"; // light red
        timerDisplay.style.color = "#b91c1c";      // red text
        timerDisplay.style.borderColor = "#b91c1c";
      }
    }

    if (remainingMs <= 0) {
      clearInterval(timer);
      submitExam("Time limit reached ‚Äì exam auto-submitted.");
    }
  }, 1000);
}

      function enableFullScreen() {
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen().catch(err => {
            console.warn("Fullscreen request failed:", err);
          });
        }
      }

      function terminateExam(message) {
        console.log("üí£ terminateExam called", {
          message,
          examActiveBefore: examActive
        });

        if (!examActive) {
          console.log("terminateExam called but examActive is already false ‚Äì ignoring.");
          return;
        }

        examActive = false;

        if (exitCountdownTimer) {
          clearInterval(exitCountdownTimer);
          exitCountdownTimer = null;
        }
        setOverlayActive(false);

        logEvent("Exam terminated", message || "Exam terminated by system.");

        alert(
          message ||
          "Vous avez quitt√© l'√©cran de l'√©preuve. L'√©preuve est termin√©e et doit √™tre recommenc√©e."
        );

        resetToLanding();
      }

      function askToExitExam(reason, source) {
        if (!examActive || examSubmitted || exitPromptOpen) return;
        if (Date.now() < antiCheatSuspendedUntil) return;

        violationCount += 1;
              // Update big warning counter: AVERTISSEMENT X / 2
      if (exitOverlayStrike) {
        const warnIndex = Math.min(violationCount, MAX_WARNINGS);
        exitOverlayStrike.textContent = `AVERTISSEMENT ${warnIndex} / ${MAX_WARNINGS}`;
      }

        const msgBase =
          reason ||
          "Vous √™tes sur le point de quitter l'√©cran de l'√©preuve. " +
          "Si vous continuez, votre √©preuve sera effac√©e.";

        const sourceText = source ? `${source} ‚Äì ` : "";

        // 3rd event (or more) ‚Üí auto-submit immediately
        if (violationCount >= MAX_VIOLATIONS) {
          logEvent(
            "Anti-cheat limit reached",
            `${sourceText}violation #${violationCount} ‚Äì exam auto-submitted.`
          );

          if (exitCountdownTimer) {
            clearInterval(exitCountdownTimer);
            exitCountdownTimer = null;
          }
          if (exitOverlay) {
            exitOverlay.style.display = "none";
          }
          setOverlayActive(false);

          alert(
            "L'√©preuve a √©t√© automatiquement envoy√©e apr√®s plusieurs sorties de l'√©cran (3 √©v√®nements d√©tect√©s)."
          );

          submitExam("Anti-cheat: 3 focus/window/fullscreen events ‚Äì exam auto-submitted.");
          return;
        }

        exitPromptOpen = true;

        const warningSuffix =
          `\n\nAvertissement ${violationCount} sur 2. ` +
          `Au-del√†, l'√©preuve sera automatiquement envoy√©e.`;

        const fullMsg = msgBase + warningSuffix;

        logEvent(
          "Exit warning shown",
          `${sourceText}violation #${violationCount} ‚Äì warning displayed.`
        );

        if (exitOverlayMessage) {
          exitOverlayMessage.textContent = fullMsg.replace(/\n+/g, " ");
        }
        if (exitOverlay) {
          exitOverlay.style.display = "flex";
        }

        setOverlayActive(true);

        // Start 15-second countdown
        exitSecondsRemaining = 15;
        if (exitOverlayCountdownText) {
          exitOverlayCountdownText.textContent =
            `Vous avez ${exitSecondsRemaining} secondes pour rester dans l'√©preuve ` +
            `avant qu'elle ne soit interrompue.`;
        }
        if (exitOverlayCountdownDigits) {
          exitOverlayCountdownDigits.textContent = exitSecondsRemaining;
        }

        if (exitCountdownTimer) {
          clearInterval(exitCountdownTimer);
        }

        exitCountdownTimer = setInterval(() => {
          exitSecondsRemaining -= 1;

          if (exitOverlayCountdownText && exitSecondsRemaining >= 0) {
            exitOverlayCountdownText.textContent =
              `Vous avez ${exitSecondsRemaining} secondes pour rester dans l'√©preuve ` +
              `avant qu'elle ne soit interrompue.`;
          }
          if (exitOverlayCountdownDigits && exitSecondsRemaining >= 0) {
            exitOverlayCountdownDigits.textContent = exitSecondsRemaining;
          }

          if (exitSecondsRemaining <= 0) {
            clearInterval(exitCountdownTimer);
            exitCountdownTimer = null;
            exitPromptOpen = false;

            if (exitOverlay) exitOverlay.style.display = "none";
            setOverlayActive(false);

            // Timeout is treated like "leave" ‚Üí exam reset, not auto-submit
            logEvent(
              "Exit warning timeout",
              `No interaction on warning #${violationCount}. Exam reset.`
            );

            terminateExam(
              "Vous n'√™tes pas revenu dans l'√©preuve √† temps. L'√©preuve a √©t√© arr√™t√©e et devra √™tre recommenc√©e."
            );
          }
        }, 1000);
      }

      // Overlay buttons
      if (exitOverlayStay) {
        exitOverlayStay.addEventListener("click", () => {
          // user chooses to continue
          if (exitCountdownTimer) {
            clearInterval(exitCountdownTimer);
            exitCountdownTimer = null;
          }

          antiCheatSuspendedUntil = Date.now() + 2000; // 2 seconds grace
          exitPromptOpen = false;

          if (exitOverlay) exitOverlay.style.display = "none";
          setOverlayActive(false);

          logEvent(
            "Student chose to stay in exam",
            `Returned after warning #${violationCount}. Fullscreen requested again.`
          );

          if (!document.fullscreenElement && document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch(() => {});
          }
        });
      }

      if (exitOverlayLeave) {
        exitOverlayLeave.addEventListener("click", () => {
          if (exitCountdownTimer) {
            clearInterval(exitCountdownTimer);
            exitCountdownTimer = null;
          }

          exitPromptOpen = false;
          if (exitOverlay) exitOverlay.style.display = "none";
          setOverlayActive(false);

          logEvent(
            "Student chose to leave exam",
            `Exam terminated by user after warning #${violationCount}.`
          );

          terminateExam(
            "Vous avez quitt√© l'√©cran de l'√©preuve. L'√©preuve est termin√©e et doit √™tre recommenc√©e."
          );
        });
      }

      // Force LAST NAME input uppercase
      studentLastNameInput.addEventListener("input", () => {
        studentLastNameInput.value = studentLastNameInput.value.toUpperCase();
      });

      // ----- Anti-cheat listeners -----
      document.addEventListener("visibilitychange", () => {
        if (isStartingExam) {
          console.log("‚è± Ignoring visibilitychange during exam startup");
          return;
        }
        if (!examActive || examSubmitted) return;
        if (Date.now() < antiCheatSuspendedUntil) return;

        if (document.hidden) {
          logEvent("Window visibility lost", "Page hidden (visibilitychange)");
          askToExitExam(
            "Vous √™tes sur le point de quitter l'√©cran de l'√©preuve.",
            "visibilitychange"
          );
        }
      });

      window.addEventListener("blur", () => {
        if (isStartingExam) {
          console.log("‚è± Ignoring blur during exam startup");
          return;
        }
        if (!examActive || examSubmitted) return;

        if (isMobile && Date.now() < safeBlurUntil) {
          console.log("üì± Blur ignored (inside safe window)", {
            now: Date.now(),
            safeBlurUntil
          });
          return;
        }

        if (Date.now() < antiCheatSuspendedUntil) {
          console.log("‚è± Blur ignored (anti-cheat grace window)");
          return;
        }

        logEvent("Window focus lost", "blur event");
        askToExitExam(
          "Vous √™tes sur le point de quitter la fen√™tre de l'√©preuve.",
          "blur"
        );
      });

      document.addEventListener("fullscreenchange", () => {
        console.log("üì∫ fullscreenchange fired", {
          examActive,
          fullscreenElement: !!document.fullscreenElement,
          isStartingExam
        });

        if (!examActive || examSubmitted || isStartingExam) return;
        if (Date.now() < antiCheatSuspendedUntil) return;

        if (!document.fullscreenElement) {
          logEvent("Fullscreen exited", "fullscreenchange event");
          askToExitExam(
            "Vous √™tes sur le point de quitter le mode plein √©cran.",
            "fullscreenchange"
          );
        }
      });

      document.addEventListener("keydown", e => {
        if ((e.key === "Escape" || e.key === "Esc") && examActive && !isStartingExam && !examSubmitted) {
          if (Date.now() < antiCheatSuspendedUntil) return;
          e.preventDefault();

          logEvent("Escape key pressed", "Possible fullscreen exit (Escape)");
          askToExitExam(
            "Vous avez appuy√© sur √âchap, ce qui quitte le mode plein √©cran.",
            "keydown(Escape)"
          );
        }
      });

      // Start from a clean landing state
      resetToLanding();

      // ----- Exam flow -----
      function beginExam() {
        const firstName = (studentFirstNameInput.value || "").trim();
        const lastName = (studentLastNameInput.value || "").trim().toUpperCase();
        const email = (studentEmailInput.value || "").trim();
        const code = (classCodeInput.value || "").trim();
        const group = selectedGroup || (groupSelect.value || "").trim();

        const fullName = `${lastName} ${firstName}`;

        studentNameField.value = fullName;
        studentEmailField.value = email;
        classCodeField.value = code;
        groupNameField.value = group;

        confirmSec.style.display = "none";
        exam.style.display = "block";
        partA.classList.add("active");
        partB.classList.remove("active");

        currentExamTitle = `${EXAM_CONFIG.examTitleBase} (${group})`;
        if (titleHeader) {
          titleHeader.textContent = currentExamTitle;
        }

        examActive = true;
        examSubmitted = false;
        violationCount = 0;

        logEvent("Exam started", `Group: ${group}, Name: ${fullName}`);

        if (!examDeadline) {
          examDeadline = Date.now() + EXAM_CONFIG.timeLimitMinutes * 60 * 1000;
          localStorage.setItem(DEADLINE_KEY, String(examDeadline));
          console.log("‚è± New examDeadline set:", new Date(examDeadline).toISOString());
        } else {
          console.log("‚è± Using existing examDeadline:", new Date(examDeadline).toISOString());
          if (Date.now() > examDeadline) {
            alert("Le d√©lai de 60 minutes est √©coul√©. Vous ne pouvez plus commencer l'√©preuve.");
            examActive = false;
            exam.style.display = "none";
            login.style.display = "block";
            return;
          }
        }

        isStartingExam = true;
        setTimeout(() => {
          isStartingExam = false;
          console.log("‚è± Startup grace period over");
        }, 1200);

        enableFullScreen();
startTimer();
randomizeQuestionOrder();
randomizeSelectsKeepFirst();
initDefinitionPreviews();   // üëà add this line
      }

      // Start ‚Üí Confirm
      startBtn.addEventListener("click", () => {
        const firstName = (studentFirstNameInput.value || "").trim();
        const lastName = (studentLastNameInput.value || "").trim().toUpperCase();
        const email = (studentEmailInput.value || "").trim();
        const code = (classCodeInput.value || "").trim();
        const group = (groupSelect.value || "").trim();

        if (!firstName || !lastName || !email) {
          alert("Merci de remplir toutes les informations (nom, pr√©nom et e-mail).");
          return;
        }

        if (!group) {
          alert("Merci de s√©lectionner votre groupe.");
          return;
        }

        const isDebug = code === EXAM_CONFIG.debugCode;
        const isRealClass = code === EXAM_CONFIG.classCode;

        if (!isDebug && !isRealClass) {
          alert("Code de classe invalide.");
          return;
        }

        const fullName = `${lastName} ${firstName}`;
        selectedGroup = group;

        confirmName.textContent = fullName;
        confirmEmail.textContent = email;
        confirmGroup.textContent = group;

        login.style.display = "none";
        confirmSec.style.display = "block";
      });

      confirmBackBtn.addEventListener("click", () => {
        confirmSec.style.display = "none";
        login.style.display = "block";
      });

      confirmBeginBtn.addEventListener("click", () => {
        beginExam();
      });

      // Navigation Part A <-> Part B
      toPartB.addEventListener("click", () => {
        partA.classList.remove("active");
        partB.classList.add("active");
        logEvent("Moved to Part B", "Student navigated from Part A to Part B");
        ensureQuill();
      });

      toPartA.addEventListener("click", () => {
        partB.classList.remove("active");
        partA.classList.add("active");
        logEvent("Returned to Part A", "Student navigated from Part B to Part A");
      });

      // Submit handler
      form.addEventListener("submit", e => {
        e.preventDefault();
        submitExam();
      });

      function submitExam(autoReason) {
        if (examSubmitted) return;
        examSubmitted = true;

        clearInterval(timer);

        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Envoi en cours‚Ä¶";
        }

        logEvent("Exam submitted", autoReason || "Student clicked submit");

        const fd = new FormData(form);
        const name = fd.get("studentName") || studentNameField.value;
        const email = fd.get("studentEmail") || studentEmailField.value;

        let minutesUsed = EXAM_CONFIG.timeLimitMinutes;
        if (examDeadline) {
          const remainingMs = examDeadline - Date.now();
          const remainingMin = Math.max(0, Math.floor(remainingMs / 60000));
          minutesUsed = EXAM_CONFIG.timeLimitMinutes - remainingMin;
        }

        const emailHtml = quill ? quill.root.innerHTML.trim() : "<em>(No response)</em>";
        const totalQs = document.querySelectorAll('#partA select[name^="q"]').length || 10;

        let scoreA = 0;
        let partARowsHTML = "";
        for (let i = 1; i <= totalQs; i++) {
          const sel = fd.get("q" + i) || "No answer";
          const corr = correctAnswers["q" + i] || "";
          const ok = sel === corr;
          if (ok) scoreA++;
          const mark = ok ? "‚úÖ Correct" : `‚ùå Incorrect ‚Üí Correct answer: ${corr}`;
          partARowsHTML += `
            <tr>
              <td style="padding:8px;border:1px solid #ccc;">${wordNames[i - 1] || ("Q" + i)}</td>
              <td style="padding:8px;border:1px solid #ccc;">${sel}</td>
              <td style="padding:8px;border:1px solid #ccc;color:${ok ? "green" : "#b00"};">${mark}</td>
            </tr>`;
        }

        const partBScore = "___ / 10";
        const finalNote = "___ / 20";
        const group = selectedGroup || groupNameField.value || EXAM_CONFIG.classLabel;

        // Build session activity log HTML
        let sessionLogHTML = "";
        if (sessionEvents.length > 0) {
          const rows = sessionEvents.map(ev => `
            <tr>
              <td style="padding:6px 8px;border:1px solid #ccc;">${ev.time}</td>
              <td style="padding:6px 8px;border:1px solid #ccc;">${ev.label}</td>
              <td style="padding:6px 8px;border:1px solid #ccc;">${ev.detail}</td>
            </tr>
          `).join("");

          sessionLogHTML = `
            <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">
            <h4 style="color:#004080;margin:10px 0 8px 0;">Exam session activity log</h4>
            <table style="border-collapse:collapse;width:100%;font-size:13px;">
              <thead>
                <tr style="background:#f3f4f6;color:#111827;text-align:left;">
                  <th style="padding:6px 8px;border:1px solid #ccc;">Time</th>
                  <th style="padding:6px 8px;border:1px solid #ccc;">Event</th>
                  <th style="padding:6px 8px;border:1px solid #ccc;">Details</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          `;
        } else {
          sessionLogHTML = `
            <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">
            <h4 style="color:#004080;margin:10px 0 8px 0;">Exam session activity log</h4>
            <p style="font-size:13px;color:#4b5563;margin:4px 0 0 0;">
              Aucun √©v√®nement particulier d√©tect√© pendant la session (pas de changement de fen√™tre ou de sortie du plein √©cran).
            </p>
          `;
        }

        const htmlReport = `
          <h2 style="color:#004080;margin:0 0 8px 0;">
            Results ‚Äì ${currentExamTitle} ‚Äì ${name}
          </h2>
          <table style="border-collapse:collapse;width:100%;max-width:640px;font-size:14px;margin:0 0 12px 0;">
            <tr><td style="padding:4px 0;"><b>Student Name:</b> ${name}</td></tr>
            <tr><td style="padding:4px 0;"><b>Student Email:</b> ${email}</td></tr>
            <tr><td style="padding:4px 0;"><b>Group:</b> ${group}</td></tr>
            <tr><td style="padding:4px 0;"><b>Time Taken:</b> ${minutesUsed} min</td></tr>
          </table>
          <hr style="border:none;border-top:1px solid #ddd;margin:14px 0;">

          <h3 style="color:#004080;margin:10px 0 8px 0;">Part A ‚Äì Vocabulary Matching</h3>
          <table style="border-collapse:collapse;width:100%;font-size:15px;margin-top:8px;">
            <thead>
              <tr style="background:#004080;color:#fff;text-align:left;">
                <th style="padding:8px;border:1px solid #ccc;">Word</th>
                <th style="padding:8px;border:1px solid #ccc;">Student Answer</th>
                <th style="padding:8px;border:1px solid #ccc;">Result</th>
              </tr>
            </thead>
            <tbody>
              ${partARowsHTML}
            </tbody>
          </table>
          <p style="margin:10px 0 0 0;"><b>Part A Score:</b> ${scoreA} / ${totalQs}</p>

          <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">

          <h3 style="color:#004080;margin:10px 0 8px 0;">Part B ‚Äì Written Exercise</h3>
          <div style="border:1px solid #ccc;border-radius:6px;padding:10px;background:#f9f9f9;">
            ${emailHtml}
          </div>

          <table style="border-collapse:collapse;width:100%;font-size:15px;margin-top:6px;">
            <thead>
              <tr style="background:#004080;color:#fff;text-align:left;">
                <th style="padding:8px;border:1px solid #ccc;">Criterion</th>
                <th style="padding:8px;border:1px solid #ccc;">Maximum</th>
                <th style="padding:8px;border:1px solid #ccc;">Awarded</th>
              </tr>
            </thead>
            <tbody>
              <tr><td style="padding:8px;border:1px solid #ccc;">Vocabulary Use</td><td style="padding:8px;border:1px solid #ccc;">/3</td><td style="padding:8px;border:1px solid #ccc;">___ / 3</td></tr>
              <tr><td style="padding:8px;border:1px solid #ccc;">Structure & Clarity</td><td style="padding:8px;border:1px solid #ccc;">/3</td><td style="padding:8px;border:1px solid #ccc;">___ / 3</td></tr>
              <tr><td style="padding:8px;border:1px solid #ccc;">Language Accuracy & Tone</td><td style="padding:8px;border:1px solid #ccc;">/2</td><td style="padding:8px;border:1px solid #ccc;">___ / 2</td></tr>
              <tr><td style="padding:8px;border:1px solid #ccc;">Professional Style</td><td style="padding:8px;border:1px solid #ccc;">/2</td><td style="padding:8px;border:1px solid #ccc;">___ / 2</td></tr>
            </tbody>
          </table>
          <p style="margin:12px 0 6px 0;"><b>Part B Score:</b> ${partBScore}</p>

          <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">

          <h4 style="color:#004080;margin:10px 0 8px 0;">Score Summary</h4>

          <table style="border-collapse:collapse;width:100%;max-width:460px;font-size:15px;">
            <tr>
              <td style="padding:8px;border:1px solid #ccc;">Part A Score</td>
              <td style="padding:8px;border:1px solid #ccc;">${scoreA} / ${totalQs}</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #ccc;">Part B Score</td>
              <td style="padding:8px;border:1px solid #ccc;">${partBScore}</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #ccc;"><b>Final Note</b></td>
              <td style="padding:8px;border:1px solid #ccc;"><b>${finalNote}</b></td>
            </tr>
          </table>

          ${sessionLogHTML}

          <div style="border-top:1px solid #ccc;margin-top:16px;padding-top:8px;font-size:12px;color:#555;">
            <em>This report was generated automatically for the English Exam ‚Äì Business Resources.</em>
          </div>
        `;

        const subject = EXAM_CONFIG.emailSubjectTemplate
          .replace("(NAME)", name)
          .replace("(GROUP)", group);

        if (window.emailjs) {
          emailjs
            .send(
              "service_opm4h6b",
              "template_r0u784p",
              {
                from_name: name,
                from_email: email,
                subject,
                message_html: htmlReport
              },
              "Bb0oPYBiZGQcyIz5r"
            )
            .then(() => {
              alert("‚úÖ √âpreuve envoy√©e avec succ√®s.");
              localStorage.removeItem(DEADLINE_KEY);
              examDeadline = null;
              resetToLanding();
            })
            .catch(err => {
              alert(
                "‚ùå Erreur lors de l'envoi de l'√©preuve : " +
                (err && err.text ? err.text : err)
              );
              console.error("EmailJS Error:", err);
              examSubmitted = false;
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = "Envoyer l'√©preuve";
              }
            });
        } else {
          alert("EmailJS n'est pas charg√© ; envoi simul√©.");
          examSubmitted = false;
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Envoyer l'√©preuve";
          }
        }
      }
    });
  </script>
</body>
</html>

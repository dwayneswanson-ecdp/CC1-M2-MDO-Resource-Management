<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google" content="notranslate">
  <meta http-equiv="Content-Language" content="en">
  <meta name="robots" content="no-translate">
  <title>CC - English -</title>

  <!-- Quill CSS -->
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
  
  <!-- Google Fonts - Inter for modern typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* Anti-copy / anti-translate behaviour – leave as is for exam security */
    html, body {
      translate: none !important;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      margin: 0;
      padding: 0;
    }
    * { translate: none !important; }

    /* ============================================
       MODERN UI UPGRADE - Matching Landing Page
       ============================================ */
    
    /* Global body with modern font */
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: #f8f9fc;
      color: #1e293b;
      font-size: 16px;
      line-height: 1.7;
      padding-top: 85px;
      font-weight: 400;
    }

    /* Modern fixed header with glassmorphism */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;

      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;

      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      color: #1e293b;
      padding: 18px 32px;
      border-bottom: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow: 0 4px 20px rgba(15, 23, 42, 0.04);
    }

    header h1 {
      margin: 0;
      font-size: 1.25rem;
      letter-spacing: -0.02em;
      font-weight: 700;
      color: #2563eb;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Modern timer with gradient background */
    #timer {
      display: none;
      font-weight: 700;
      font-size: 1rem;
      text-align: right;
      padding: 10px 20px;
      border-radius: 999px;
      border: 2px solid #2563eb;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: #ffffff;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
      letter-spacing: 0.02em;
      transition: all 0.3s ease;
    }

    /* Main exam wrapper with better spacing */
    main {
      max-width: 960px;
      margin: 32px auto 60px;
      background: #ffffff;
      padding: 48px 48px 56px;
      border-radius: 20px;
      box-shadow: 0 8px 40px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(226, 232, 240, 0.8);
    }

    /* Modern card style matching landing page */
    .card {
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 6px 30px rgba(15, 23, 42, 0.08);
      padding: 40px 40px 48px;
      max-width: 680px;
      margin: 40px auto;
      text-align: left;
      border: 1px solid rgba(226, 232, 240, 0.8);
    }

    .card h2 {
      color: #0f172a;
      margin-top: 0;
      margin-bottom: 12px;
      text-align: center;
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .card p {
      font-size: 1rem;
      line-height: 1.7;
      color: #475569;
    }

    /* Modern form elements */
    label {
      display: block;
      margin: 20px 0 10px;
      font-weight: 600;
      font-size: 0.95rem;
      color: #0f172a;
      letter-spacing: -0.01em;
    }

    input[type="text"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: 'Inter', inherit;
      box-sizing: border-box;
      background: #ffffff;
      color: #1e293b;
      transition: all 0.2s ease;
      font-weight: 400;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
      line-height: 1.6;
    }

    select {
      white-space: normal;
      word-wrap: break-word;
      padding: 12px 16px;
      background: #ffffff;
      cursor: pointer;
    }

    /* Modern button styles */
    button {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: #fff;
      border: none;
      padding: 14px 32px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      font-family: 'Inter', inherit;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.25);
      transition: all 0.3s ease;
      letter-spacing: 0.01em;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.35);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      margin-top: 24px;
    }
    .btn-row.center { justify-content: center; }
    .btn-row.right { justify-content: flex-end; }

    .btn-light {
      background: #f1f5f9;
      color: #2563eb;
      border: 2px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
    }
    .btn-light:hover {
      background: #e2e8f0;
      border-color: #cbd5e1;
    }

    /* Improved list styling */
    ol, ul {
      padding-left: 24px;
      margin: 16px 0;
    }
    
    ol li, ul li {
      margin-bottom: 14px;
      font-size: 0.95rem;
      line-height: 1.7;
      color: #475569;
    }

    /* Horizontal rules */
    hr {
      margin: 28px 0;
      border: none;
      border-top: 2px solid #f1f5f9;
    }

    /* STEP / PART VISIBILITY – functional: do NOT change selectors */
    #exam,
    #confirm,
    #partA,
    #partB {
      display: none;
    }
    #partA.active,
    #partB.active {
      display: block;
    }

    /* Modern Quill editor */
    .editor-card {
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(15, 23, 42, 0.06);
      margin-top: 16px;
      transition: all 0.2s ease;
    }

    .editor-card:focus-within {
      border-color: #2563eb;
      box-shadow: 0 4px 20px rgba(37, 99, 235, 0.12);
    }

    .ql-toolbar.ql-snow {
      border: none;
      border-bottom: 2px solid #f1f5f9;
      background: #f8f9fc;
      padding: 12px;
    }

    .ql-container.ql-snow {
      border: none;
      min-height: 300px;
      background: #ffffff;
    }

    .ql-editor {
      min-height: 280px;
      font-size: 0.95rem;
      font-family: 'Inter', inherit;
      line-height: 1.7;
      padding: 20px;
    }

    .muted {
      color: #64748b;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    /* Name row layout */
    .name-row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }
    .name-row .field {
      flex: 1 1 0;
      min-width: 200px;
    }

    /* Visually force uppercase display on last name */
    .upper {
      text-transform: uppercase;
    }

    /* === Part A – Modern Vocabulary Matching === */
    #partA h2 {
      text-align: left;
      margin-bottom: 8px;
      font-size: 1.75rem;
      font-weight: 700;
      color: #0f172a;
    }

    .partA-intro {
      font-size: 0.95rem;
      color: #64748b;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    #partA ol {
      margin: 0;
      padding-left: 2rem;
      counter-reset: item;
    }

    #partA ol li {
      border-bottom: 1px solid #f1f5f9;
      padding-bottom: 20px;
      margin-bottom: 20px;
      transition: all 0.2s ease;
    }
    
    #partA ol li:hover {
      background: #f8f9fc;
      margin-left: -12px;
      margin-right: -12px;
      padding-left: 12px;
      padding-right: 12px;
      border-radius: 12px;
    }
    
    #partA ol li:last-child {
      border-bottom: none;
    }

    .definition-preview {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #64748b;
      font-style: italic;
      line-height: 1.5;
    }

    .vocab-row {
      display: grid;
      grid-template-columns: minmax(0, 0.6fr) minmax(0, 1.4fr);
      column-gap: 24px;
      align-items: center;
    }

    .vocab-term {
      font-size: 1rem;
      color: #0f172a;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .vocab-select {
      margin: 0;
    }

    /* Part B section styling */
    #partB h2 {
      text-align: left;
      margin-bottom: 8px;
      font-size: 1.75rem;
      font-weight: 700;
      color: #0f172a;
    }

    #partB .muted strong {
      color: #475569;
      font-weight: 600;
    }

    /* Modern exit warning overlay */
    body.exit-lock {
      overflow: hidden;
    }
    body.exit-lock header,
    body.exit-lock main {
      filter: blur(8px);
      pointer-events: none;
    }

    body.overlay-active main,
    body.overlay-active header {
      filter: blur(8px);
      pointer-events: none;
    }

    body.overlay-active {
      overflow: hidden;
    }

    #exitOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #exitOverlay > div {
      background: #ffffff;
      max-width: 480px;
      width: 92%;
      border-radius: 24px;
      padding: 32px 32px 28px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.4);
      font-family: 'Inter', system-ui, sans-serif;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    #exitOverlay h2 {
      margin: 0 0 12px 0;
      font-size: 1.5rem;
      color: #0f172a;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    #exitOverlayStrike {
      margin: 8px 0 12px 0;
      font-size: 1.5rem;
      font-weight: 800;
      color: #dc2626;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      text-align: left;
    }

    #exitOverlayMessage {
      margin: 0 0 16px 0;
      font-size: 0.95rem;
      color: #475569;
      line-height: 1.6;
    }

    #exitOverlayCountdownText {
      margin: 16px 0 8px 0;
      font-size: 0.9rem;
      color: #64748b;
      text-align: center;
      line-height: 1.5;
    }

    #exitOverlayCountdownDigits {
      font-size: 3.5rem;
      font-weight: 800;
      text-align: center;
      margin: 0 0 24px 0;
      color: #dc2626;
      font-family: 'Inter', monospace;
      letter-spacing: -0.02em;
    }

    #exitOverlay button {
      padding: 12px 24px;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #exitOverlayStay {
      border: 2px solid #cbd5e1;
      background: #f1f5f9;
      color: #2563eb;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
    }

    #exitOverlayStay:hover {
      background: #e2e8f0;
      border-color: #94a3b8;
      transform: translateY(-1px);
    }

    #exitOverlayLeave {
      border: none;
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(220, 38, 38, 0.3);
    }

    #exitOverlayLeave:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
    }

    /* Responsive tweaks */
    @media (max-width: 768px) {
      body {
        padding-top: 100px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        padding-inline: 20px;
      }

      #timer {
        align-self: flex-end;
        font-size: 0.9rem;
        padding: 8px 16px;
      }

      main {
        margin: 20px auto 40px;
        padding: 32px 24px 40px;
        border-radius: 16px;
      }

      .card {
        margin: 32px auto;
        padding: 32px 24px 40px;
        max-width: 100%;
      }

      .vocab-row {
        grid-template-columns: 1fr;
        row-gap: 10px;
      }

      .name-row .field {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1 id="examTitleHeader">CC1 - English — Resource Management</h1>
    <div id="timer"></div>
  </header>

  <main>
    <span id="langSentinel" style="display:none;">
      This reference sentence is used only to detect automatic translation of the exam page.
    </span>
    
    <!-- LOGIN -->
    <section id="login" class="card">
      <h2>Commencer l'épreuve</h2>
      <p>Merci de renseigner vos informations pour commencer. Une fois l'épreuve lancée, vous disposerez de <b>60 minutes</b> pour la compléter.</p>

      <label>Nom et prénom :</label>
      <div class="name-row">
        <div class="field">
          <input type="text" id="studentLastName" class="upper" placeholder="NOM (en majuscules)" required>
        </div>
        <div class="field">
          <input type="text" id="studentFirstName" placeholder="Prénom" required>
        </div>
      </div>

      <label>Adresse e-mail :</label>
      <input type="email" id="studentEmail" required>

      <label>Groupe :</label>
      <select id="groupSelect" required>
        <option value="">Sélectionner votre groupe</option>
        <option value="M2 MDO G1">M2 MDO G1</option>
        <option value="M2 MDO G2">M2 MDO G2</option>
        <option value="M2 MDO G3">M2 MDO G3</option>
      </select>

      <label>Code de classe :</label>
      <input type="text" id="classCode" required>

      <div class="btn-row center">
        <button id="startBtn" type="button">Commencer</button>
      </div>
    </section>

    <!-- CONFIRM -->
    <section id="confirm" class="card">
      <h2>Avant de commencer l'épreuve</h2>

      <p class="muted"><strong>Comment fonctionne l'épreuve&nbsp;?</strong></p>
      <ul class="muted">
        <li>L'épreuve se déroule en <strong>plein écran</strong>.</li>
        <li>Si vous quittez la fenêtre ou changez d'application, un <strong>message d'avertissement</strong> apparaît.</li>
        <li>Vous avez <strong>15&nbsp;secondes</strong> pour revenir, sinon l'épreuve est arrêtée et devra être recommencée.</li>
        <li>Après <strong>3 évènements techniques</strong> (sortie du plein écran, changement de fenêtre, etc.), l'épreuve est <strong>envoyée automatiquement</strong> à l'enseignant.</li>
      </ul>

      <hr>

      <p class="muted"><strong>Vérifiez vos informations</strong></p>
      <p><b>Nom &amp; prénom :</b> <span id="confirmName"></span></p>
      <p><b>Email :</b> <span id="confirmEmail"></span></p>
      <p><b>Groupe :</b> <span id="confirmGroup"></span></p>
      <p class="muted">
        Si quelque chose n'est pas correct, cliquez sur «&nbsp;Modifier&nbsp;» pour revenir à l'écran précédent.
      </p>

      <div class="btn-row">
        <button type="button" class="btn-light" id="confirmBackBtn">← Modifier</button>
        <button type="button" id="confirmBeginBtn">Commencer l'épreuve →</button>
      </div>
    </section>

    <!-- EXAM -->
    <section id="exam">
      <form id="examForm">
        <input type="hidden" name="studentName" id="studentNameField">
        <input type="hidden" name="studentEmail" id="studentEmailField">
        <input type="hidden" name="classCode" id="classCodeField">
        <input type="hidden" name="groupName" id="groupNameField">

        <!-- PART A -->
        <div id="partA" class="active">
          <h2>Part A – Vocabulary Matching</h2>
          <p class="partA-intro">
            Match each term with the correct definition by selecting an option in the dropdown list.
          </p>

          <ol>
            <li>
              <div class="vocab-row">
                <span class="vocab-term">Budget</span>
                <select name="q1" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                <div class="definition-preview" data-for="q1"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Forecast</span>
                <select name="q2" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                <div class="definition-preview" data-for="q2"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">KPI (Key Performance Indicator)</span>
                <select name="q3" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                <div class="definition-preview" data-for="q3"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Supplier</span>
                <select name="q4" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                <div class="definition-preview" data-for="q4"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Headcount</span>
                <select name="q5" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                <div class="definition-preview" data-for="q5"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Lead time</span>
                <select name="q6" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                <div class="definition-preview" data-for="q6"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Inventory</span>
                <select name="q7" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                <div class="definition-preview" data-for="q7"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Overhead</span>
                <select name="q8" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                <div class="definition-preview" data-for="q8"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">Sustainability</span>
                <select name="q9" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                <div class="definition-preview" data-for="q9"></div>
              </div>
            </li>

            <li>
              <div class="vocab-row">
                <span class="vocab-term">ROI (Return on Investment)</span>
                <select name="q10" class="vocab-select">
                  <option value="">Select a definition</option>
                  <option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option>
                  <option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option>
                  <option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option>
                  <option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option>
                  <option>The total number of employees working in an organisation, department, or team.</option>
                  <option>The time between placing an order and receiving the product or service, including production and delivery.</option>
                  <option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option>
                  <option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option>
                  <option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option>
                  <option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
                </select>
                <div class="definition-preview" data-for="q10"></div>
              </div>
            </li>
          </ol>

          <div class="btn-row right">
            <button type="button" id="toPartB">Suivant → Part B</button>
          </div>
        </div>

        <!-- PART B -->
        <div id="partB">
          <h2>Part B – Writing: Email to Your Manager</h2>

          <p class="muted"><strong>Context</strong></p>
          <p class="muted">
            You work for an emerging sports brand. In a meeting, we discussed the business strategy of the
            sportswear brand <em>On</em>, and how it uses its resources to support growth and stay competitive
            (planning, costs, suppliers, customers, etc.). Your manager did not attend the presentation but
            wants to understand what you learned and how it could help the company.
          </p>

          <p class="muted"><strong>Task</strong></p>
          <ul class="muted">
            <li>Explain how On is managing its resources (in your own words).</li>
            <li>Analyse why this approach is important for long-term performance.</li>
            <li>Suggest 1–2 concrete actions a sportswear company could take to improve its strategy.</li>
          </ul>

          <p class="muted"><strong>Requirements</strong></p>
          <ul class="muted">
            <li>Use at least THREE (3) words from the vocabulary discussed in class.</li>
            <li>
              Include a clear email structure:
              subject line, short introduction, development, conclusion, and 
              appropriate sign-off.
            </li>
            <li>Use formal, professional language.</li>
            <li>Write a coherent, well-organised email.</li>
          </ul>

          <div class="editor-card">
            <div id="editor"></div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-light" id="toPartA">← Retour à la partie A</button>
            <button type="submit">Envoyer l'épreuve</button>
          </div>
        </div>
      </form>
    </section>
  </main>

  <!-- Exit warning overlay -->
  <div id="exitOverlay">
    <div>
      <h2>Quitter l'épreuve ?</h2>
      <div id="exitOverlayStrike"></div>
      <p id="exitOverlayMessage">
        Vous êtes sur le point de quitter l'écran de l'épreuve.
        Si vous continuez, votre épreuve sera effacée.
      </p>

      <p id="exitOverlayCountdownText">
        Vous avez 15&nbsp;secondes pour rester dans l'épreuve avant qu'elle ne soit interrompue.
      </p>
      <div id="exitOverlayCountdownDigits">15</div>

      <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:8px;">
        <button type="button" id="exitOverlayStay">
          Rester dans l'épreuve
        </button>
        <button type="button" id="exitOverlayLeave">
          Quitter et effacer
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

  <script>
    // ----- Global configuration for this exam -----
    const EXAM_CONFIG = {
      examId: "M2MD_CC1_2025",
      classCode: "Q73CB",
      debugCode: "DEBUG",
      examTitleBase: "CC1 - English — Resource Management",
      allowedGroups: ["M2 MDO G1", "M2 MDO G2", "M2 MDO G3"],
      timeLimitMinutes: 60,
      emailSubjectTemplate: "(NAME) CC1 - English - (GROUP)",
      classLabel: "M2MDOG"
    };

    const DEADLINE_KEY = "examDeadline_" + EXAM_CONFIG.examId;
    let examDeadline = null;
    let timer = null;
    let quill = null;
    let isMobile = false;
    let safeBlurUntil = 0;

    let violationCount = 0;
    const MAX_VIOLATIONS = 3;
    const MAX_WARNINGS = MAX_VIOLATIONS - 1;
    let exitCountdownTimer = null;
    let exitSecondsRemaining = 0;

    let selectedGroup = "";
    let currentExamTitle = EXAM_CONFIG.examTitleBase;

    function armSafeBlur(ms = 1200) {
      safeBlurUntil = Date.now() + ms;
    }

    // Restore deadline ONLY if still valid
    (function restoreDeadline() {
      const stored = localStorage.getItem(DEADLINE_KEY);
      if (!stored) return;
      const parsed = parseInt(stored, 10);
      if (!Number.isNaN(parsed) && parsed > Date.now()) {
        examDeadline = parsed;
        console.log("⏱ Restored valid examDeadline:", new Date(examDeadline).toISOString());
      } else {
        console.log("⏱ Stored examDeadline expired/invalid → clearing.");
        localStorage.removeItem(DEADLINE_KEY);
      }
    })();

    // Correct answers + word list (Part A)
    const correctAnswers = {
      q1: "A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.",
      q2: "A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.",
      q3: "A measurable value that shows how effectively a company or team is achieving an important business objective.",
      q4: "A company or person that provides goods or services to another company, usually as part of a commercial contract.",
      q5: "The total number of employees working in an organisation, department, or team.",
      q6: "The time between placing an order and receiving the product or service, including production and delivery.",
      q7: "The stock of goods, materials, or products that a company holds for use in production or for sale to customers.",
      q8: "The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.",
      q9: "Doing business in a way that meets current needs without harming the environment, society, or future generations.",
      q10: "A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage."
    };

    const wordNames = [
      "Budget",
      "Forecast",
      "KPI (Key Performance Indicator)",
      "Supplier",
      "Headcount",
      "Lead time",
      "Inventory",
      "Overhead",
      "Sustainability",
      "ROI (Return on Investment)"
    ];

    // Create Quill lazily
    function ensureQuill() {
      if (quill) return;

      quill = new Quill("#editor", {
        theme: "snow",
        modules: {
          toolbar: [
            ["bold", "italic", "underline"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["clean"]
          ]
        }
      });

      const root = quill.root;

      ["focus", "click", "keydown"].forEach(evt => {
        root.addEventListener(evt, () => {
          if (isMobile) armSafeBlur(1500);
        });
      });

      root.addEventListener("contextmenu", e => e.preventDefault());
      root.addEventListener("paste", e => e.preventDefault());
      root.addEventListener("copy", e => e.preventDefault());
      root.addEventListener("cut", e => e.preventDefault());
      root.addEventListener("drop", e => e.preventDefault());
      root.addEventListener("keydown", e => {
        if ((e.ctrlKey || e.metaKey) && ["c", "v", "x", "a"].includes(e.key.toLowerCase())) {
          e.preventDefault();
        }
      });
    }

    // Randomise options but keep first option
    function randomizeSelectsKeepFirst() {
      document.querySelectorAll("#partA select").forEach(sel => {
        const opts = Array.from(sel.options);
        const first = opts.shift();
        for (let i = opts.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [opts[i].text, opts[j].text] = [opts[j].text, opts[i].text];
        }
        sel.innerHTML = "";
        sel.appendChild(first);
        opts.forEach(o => sel.appendChild(o));
        sel.selectedIndex = 0;
      });
    }

    function initDefinitionPreviews() {
      document.querySelectorAll('#partA select').forEach(sel => {
        const name = sel.name;
        const preview = document.querySelector(
          `.definition-preview[data-for="${name}"]`
        );
        if (!preview) return;

        const update = () => {
          const opt = sel.options[sel.selectedIndex];
          const text = opt ? opt.text : "";

          if (!opt || sel.selectedIndex === 0) {
            preview.textContent = "";
            sel.title = "";
            return;
          }

          preview.textContent = text;
          sel.title = text;
        };

        sel.addEventListener("change", update);
        update();
      });
    }

    // Randomise question order
    function randomizeQuestionOrder() {
      const list = document.querySelector("#partA ol");
      if (!list) return;
      const items = Array.from(list.children);

      for (let i = items.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [items[i], items[j]] = [items[j], items[i]];
      }

      items.forEach(li => list.appendChild(li));
    }

    document.addEventListener("DOMContentLoaded", function() {
      const ua = navigator.userAgent;
      const isIOSUA =
        /iPad|iPhone|iPod/.test(ua) ||
        (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

      isMobile = /Mobi|Android/i.test(ua) || isIOSUA;

      document.addEventListener("contextmenu", function (e) {
        e.preventDefault();
      }, { capture: true });

      const BLOCK_SAFARI = false;
      const isSafari = /^((?!chrome|crios|fxios|android).)*safari/i.test(ua);

      if (isSafari && BLOCK_SAFARI) {
        const main = document.querySelector("main");
        if (main) {
          main.innerHTML = `
            <section class="card">
              <h2 style="display:flex; align-items:center; gap:8px; margin-top:0;">
                <span>⚠️</span>
                <span>Navigateur non pris en charge</span>
              </h2>
              <p>
                Pour des raisons techniques, cette épreuve en ligne n'est pas disponible sur
                <strong>Safari</strong>.
              </p>
              <p>
                Merci d'ouvrir ce lien dans l'un des navigateurs suivants&nbsp;:
              </p>
              <ul>
                <li><strong>Google Chrome</strong></li>
                <li><strong>Microsoft Edge</strong></li>
                <li><strong>Mozilla Firefox</strong></li>
              </ul>
              <p class="muted">
                Si vous voyez encore ce message alors que vous utilisez déjà l'un de ces navigateurs,
                merci d'en informer immédiatement votre enseignant.
              </p>
            </section>
          `;
        }

        const timerEl = document.getElementById("timer");
        if (timerEl) timerEl.textContent = "";
        return;
      }

      if (window.emailjs) {
        try {
          emailjs.init({
            publicKey: "Bb0oPYBiZGQcyIz5r",
          });
        } catch (e) {
          console.error("EmailJS init error:", e);
        }
      }

      const login = document.getElementById("login");
      const confirmSec = document.getElementById("confirm");
      const exam = document.getElementById("exam");
      const titleHeader = document.getElementById("examTitleHeader");

      if (titleHeader) {
        titleHeader.textContent = EXAM_CONFIG.examTitleBase;
      }

      const startBtn = document.getElementById("startBtn");
      const confirmBackBtn = document.getElementById("confirmBackBtn");
      const confirmBeginBtn = document.getElementById("confirmBeginBtn");

      const confirmName = document.getElementById("confirmName");
      const confirmEmail = document.getElementById("confirmEmail");
      const confirmGroup = document.getElementById("confirmGroup");

      const partA = document.getElementById("partA");
      const partB = document.getElementById("partB");
      const toPartA = document.getElementById("toPartA");
      const toPartB = document.getElementById("toPartB");

      const timerDisplay = document.getElementById("timer");
      const form = document.getElementById("examForm");

      const studentFirstNameInput = document.getElementById("studentFirstName");
      const studentLastNameInput = document.getElementById("studentLastName");
      const studentEmailInput = document.getElementById("studentEmail");
      const classCodeInput = document.getElementById("classCode");
      const groupSelect = document.getElementById("groupSelect");

      const studentNameField = document.getElementById("studentNameField");
      const studentEmailField = document.getElementById("studentEmailField");
      const classCodeField = document.getElementById("classCodeField");
      const groupNameField = document.getElementById("groupNameField");

      const exitOverlay = document.getElementById("exitOverlay");
      const exitOverlayMessage = document.getElementById("exitOverlayMessage");
      const exitOverlayStay = document.getElementById("exitOverlayStay");
      const exitOverlayLeave = document.getElementById("exitOverlayLeave");
      const exitOverlayCountdownText = document.getElementById("exitOverlayCountdownText");
      const exitOverlayCountdownDigits = document.getElementById("exitOverlayCountdownDigits");
      const exitOverlayStrike = document.getElementById("exitOverlayStrike");

      const langSentinel = document.getElementById("langSentinel");
      const langSentinelBaseline = langSentinel
        ? langSentinel.textContent.trim()
        : null;

      if (langSentinel && langSentinelBaseline) {
        setInterval(() => {
          if (!examActive || examSubmitted) return;

          const current = langSentinel.textContent.trim();
          if (current !== langSentinelBaseline) {
            logEvent(
              "Possible page translation detected",
              `Sentinel changed from "${langSentinelBaseline}" to "${current}".`
            );

            askToExitExam(
              "Une modification automatique de la langue de la page a été détectée. " +
              "Merci de désactiver la traduction et de rester sur la version originale de l'épreuve.",
              "translationWatch"
            );
          }
        }, 2000);
      }

      const submitBtn = form ? form.querySelector('button[type="submit"]') : null;

      document.querySelectorAll("#partA select").forEach(sel => {
        sel.addEventListener("mousedown", () => {
          if (isMobile) armSafeBlur(1500);
        });
        sel.addEventListener("touchstart", () => {
          if (isMobile) armSafeBlur(2000);
        });
      });

      const sessionEvents = [];

      function formatTimeStamp(date = new Date()) {
        try {
          return date.toLocaleTimeString("fr-FR", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
          });
        } catch (e) {
          return date.toISOString();
        }
      }

      function logEvent(label, detail) {
        const entry = {
          time: formatTimeStamp(),
          label: label || "",
          detail: detail || ""
        };
        sessionEvents.push(entry);
        console.log("[SESSION]", entry);
      }

      const required = [
        login, confirmSec, exam, startBtn, confirmBackBtn, confirmBeginBtn,
        confirmName, confirmEmail, confirmGroup, partA, partB, toPartA, toPartB,
        timerDisplay, form, studentFirstNameInput, studentLastNameInput,
        studentEmailInput, classCodeInput, groupSelect
      ];
      if (required.some(n => !n)) {
        console.error("Missing required DOM nodes. Check IDs.", { required });
        return;
      }

      let examSubmitted = false;
      let examActive = false;
      let isStartingExam = false;
      let exitPromptOpen = false;
      let antiCheatSuspendedUntil = 0;

      function setOverlayActive(active) {
        if (active) {
          document.body.classList.add("overlay-active", "exit-lock");
        } else {
          document.body.classList.remove("overlay-active", "exit-lock");
        }
      }

      function resetToLanding() {
        console.log("🔄 resetToLanding called");

        try {
          clearInterval(timer);
        } catch (e) {
          console.error("Error clearing timer in resetToLanding:", e);
        }

        if (timerDisplay) {
          timerDisplay.textContent = "";
          timerDisplay.style.display = "none";
        }

        if (exitCountdownTimer) {
          clearInterval(exitCountdownTimer);
          exitCountdownTimer = null;
        }

        examActive = false;
        examSubmitted = false;
        isStartingExam = false;
        exitPromptOpen = false;
        antiCheatSuspendedUntil = 0;
        violationCount = 0;
        sessionEvents.length = 0;
        setOverlayActive(false);

        if (form) form.reset();
        if (quill) quill.setText("");

        if (studentFirstNameInput) studentFirstNameInput.value = "";
        if (studentLastNameInput) studentLastNameInput.value = "";
        if (studentEmailInput) studentEmailInput.value = "";
        if (classCodeInput) classCodeInput.value = "";
        if (groupSelect) groupSelect.value = "";
        selectedGroup = "";
        currentExamTitle = EXAM_CONFIG.examTitleBase;

        if (titleHeader) {
          titleHeader.textContent = currentExamTitle;
        }

        login.style.display = "block";
        confirmSec.style.display = "none";
        exam.style.display = "none";

        if (exitOverlay) exitOverlay.style.display = "none";

        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Envoyer l'épreuve";
        }

        console.log("✅ Landing screen forced.");
      }

      function startTimer() {
        clearInterval(timer);
        timer = setInterval(() => {
          if (!examDeadline) return;
          const now = Date.now();
          const remainingMs = examDeadline - now;
          const totalSec = Math.max(0, Math.floor(remainingMs / 1000));
          const m = Math.floor(totalSec / 60);
          const s = totalSec % 60;

          if (timerDisplay) {
            timerDisplay.textContent = `Temps restant : ${m}:${s
              .toString()
              .padStart(2, "0")}`;

            if (totalSec > 5 * 60) {
              timerDisplay.style.background = "linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)";
              timerDisplay.style.color = "#ffffff";
              timerDisplay.style.borderColor = "#2563eb";
              timerDisplay.style.boxShadow = "0 4px 12px rgba(37, 99, 235, 0.25)";
            } else {
              timerDisplay.style.background = "linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)";
              timerDisplay.style.color = "#ffffff";
              timerDisplay.style.borderColor = "#dc2626";
              timerDisplay.style.boxShadow = "0 4px 16px rgba(220, 38, 38, 0.35)";
            }
          }

          if (remainingMs <= 0) {
            clearInterval(timer);
            submitExam("Time limit reached – exam auto-submitted.");
          }
        }, 1000);
      }

      function enableFullScreen() {
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen().catch(err => {
            console.warn("Fullscreen request failed:", err);
          });
        }
      }

      function terminateExam(message) {
        console.log("💣 terminateExam called", {
          message,
          examActiveBefore: examActive
        });

        if (!examActive) {
          console.log("terminateExam called but examActive is already false – ignoring.");
          return;
        }

        examActive = false;

        if (exitCountdownTimer) {
          clearInterval(exitCountdownTimer);
          exitCountdownTimer = null;
        }
        setOverlayActive(false);

        logEvent("Exam terminated", message || "Exam terminated by system.");

        alert(
          message ||
          "Vous avez quitté l'écran de l'épreuve. L'épreuve est terminée et doit être recommencée."
        );

        resetToLanding();
      }

      function askToExitExam(reason, source) {
        if (!examActive || examSubmitted || exitPromptOpen) return;
        if (Date.now() < antiCheatSuspendedUntil) return;

        violationCount += 1;
        
        if (exitOverlayStrike) {
          const warnIndex = Math.min(violationCount, MAX_WARNINGS);
          exitOverlayStrike.textContent = `AVERTISSEMENT ${warnIndex} / ${MAX_WARNINGS}`;
        }

        const msgBase =
          reason ||
          "Vous êtes sur le point de quitter l'écran de l'épreuve. " +
          "Si vous continuez, votre épreuve sera effacée.";

        const sourceText = source ? `${source} – ` : "";

        if (violationCount >= MAX_VIOLATIONS) {
          logEvent(
            "Anti-cheat limit reached",
            `${sourceText}violation #${violationCount} – exam auto-submitted.`
          );

          if (exitCountdownTimer) {
            clearInterval(exitCountdownTimer);
            exitCountdownTimer = null;
          }
          if (exitOverlay) {
            exitOverlay.style.display = "none";
          }
          setOverlayActive(false);

          alert(
            "L'épreuve a été automatiquement envoyée après plusieurs sorties de l'écran (3 évènements détectés)."
          );

          submitExam("Anti-cheat: 3 focus/window/fullscreen events – exam auto-submitted.");
          return;
        }

        exitPromptOpen = true;

        const warningSuffix =
          `\n\nAvertissement ${violationCount} sur 2. ` +
          `Au-delà, l'épreuve sera automatiquement envoyée.`;

        const fullMsg = msgBase + warningSuffix;

        logEvent(
          "Exit warning shown",
          `${sourceText}violation #${violationCount} – warning displayed.`
        );

        if (exitOverlayMessage) {
          exitOverlayMessage.textContent = fullMsg.replace(/\n+/g, " ");
        }
        if (exitOverlay) {
          exitOverlay.style.display = "flex";
        }

        setOverlayActive(true);

        exitSecondsRemaining = 15;
        if (exitOverlayCountdownText) {
          exitOverlayCountdownText.textContent =
            `Vous avez ${exitSecondsRemaining} secondes pour rester dans l'épreuve ` +
            `avant qu'elle ne soit interrompue.`;
        }
        if (exitOverlayCountdownDigits) {
          exitOverlayCountdownDigits.textContent = exitSecondsRemaining;
        }

        if (exitCountdownTimer) {
          clearInterval(exitCountdownTimer);
        }

        exitCountdownTimer = setInterval(() => {
          exitSecondsRemaining -= 1;

          if (exitOverlayCountdownText && exitSecondsRemaining >= 0) {
            exitOverlayCountdownText.textContent =
              `Vous avez ${exitSecondsRemaining} secondes pour rester dans l'épreuve ` +
              `avant qu'elle ne soit interrompue.`;
          }
          if (exitOverlayCountdownDigits && exitSecondsRemaining >= 0) {
            exitOverlayCountdownDigits.textContent = exitSecondsRemaining;
          }

          if (exitSecondsRemaining <= 0) {
            clearInterval(exitCountdownTimer);
            exitCountdownTimer = null;
            exitPromptOpen = false;

            if (exitOverlay) exitOverlay.style.display = "none";
            setOverlayActive(false);

            logEvent(
              "Exit warning timeout",
              `No interaction on warning #${violationCount}. Exam reset.`
            );

            terminateExam(
              "Vous n'êtes pas revenu dans l'épreuve à temps. L'épreuve a été arrêtée et devra être recommencée."
            );
          }
        }, 1000);
      }

      if (exitOverlayStay) {
        exitOverlayStay.addEventListener("click", () => {
          if (exitCountdownTimer) {
            clearInterval(exitCountdownTimer);
            exitCountdownTimer = null;
          }

          antiCheatSuspendedUntil = Date.now() + 2000;
          exitPromptOpen = false;

          if (exitOverlay) exitOverlay.style.display = "none";
          setOverlayActive(false);

          logEvent(
            "Student chose to stay in exam",
            `Returned after warning #${violationCount}. Fullscreen requested again.`
          );

          if (!document.fullscreenElement && document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch(() => {});
          }
        });
      }

      if (exitOverlayLeave) {
        exitOverlayLeave.addEventListener("click", () => {
          if (exitCountdownTimer) {
            clearInterval(exitCountdownTimer);
            exitCountdownTimer = null;
          }

          exitPromptOpen = false;
          if (exitOverlay) exitOverlay.style.display = "none";
          setOverlayActive(false);

          logEvent(
            "Student chose to leave exam",
            `Exam terminated by user after warning #${violationCount}.`
          );

          terminateExam(
            "Vous avez quitté l'écran de l'épreuve. L'épreuve est terminée et doit être recommencée."
          );
        });
      }

      studentLastNameInput.addEventListener("input", () => {
        studentLastNameInput.value = studentLastNameInput.value.toUpperCase();
      });

      document.addEventListener("visibilitychange", () => {
        if (isStartingExam) {
          console.log("⏱ Ignoring visibilitychange during exam startup");
          return;
        }
        if (!examActive || examSubmitted) return;
        if (Date.now() < antiCheatSuspendedUntil) return;

        if (document.hidden) {
          logEvent("Window visibility lost", "Page hidden (visibilitychange)");
          askToExitExam(
            "Vous êtes sur le point de quitter l'écran de l'épreuve.",
            "visibilitychange"
          );
        }
      });

      window.addEventListener("blur", () => {
        if (isStartingExam) {
          console.log("⏱ Ignoring blur during exam startup");
          return;
        }
        if (!examActive || examSubmitted) return;

        if (isMobile && Date.now() < safeBlurUntil) {
          console.log("📱 Blur ignored (inside safe window)", {
            now: Date.now(),
            safeBlurUntil
          });
          return;
        }

        if (Date.now() < antiCheatSuspendedUntil) {
          console.log("⏱ Blur ignored (anti-cheat grace window)");
          return;
        }

        logEvent("Window focus lost", "blur event");
        askToExitExam(
          "Vous êtes sur le point de quitter la fenêtre de l'épreuve.",
          "blur"
        );
      });

      document.addEventListener("fullscreenchange", () => {
        console.log("📺 fullscreenchange fired", {
          examActive,
          fullscreenElement: !!document.fullscreenElement,
          isStartingExam
        });

        if (!examActive || examSubmitted || isStartingExam) return;
        if (Date.now() < antiCheatSuspendedUntil) return;

        if (!document.fullscreenElement) {
          logEvent("Fullscreen exited", "fullscreenchange event");
          askToExitExam(
            "Vous êtes sur le point de quitter le mode plein écran.",
            "fullscreenchange"
          );
        }
      });

      document.addEventListener("keydown", e => {
        if ((e.key === "Escape" || e.key === "Esc") && examActive && !isStartingExam && !examSubmitted) {
          if (Date.now() < antiCheatSuspendedUntil) return;
          e.preventDefault();

          logEvent("Escape key pressed", "Possible fullscreen exit (Escape)");
          askToExitExam(
            "Vous avez appuyé sur Échap, ce qui quitte le mode plein écran.",
            "keydown(Escape)"
          );
        }
      });

      resetToLanding();

      function beginExam() {
        const firstName = (studentFirstNameInput.value || "").trim();
        const lastName = (studentLastNameInput.value || "").trim().toUpperCase();
        const email = (studentEmailInput.value || "").trim();
        const code = (classCodeInput.value || "").trim();
        const group = selectedGroup || (groupSelect.value || "").trim();

        const fullName = `${lastName} ${firstName}`;

        studentNameField.value = fullName;
        studentEmailField.value = email;
        classCodeField.value = code;
        groupNameField.value = group;

        confirmSec.style.display = "none";
        exam.style.display = "block";
        partA.classList.add("active");
        partB.classList.remove("active");

        currentExamTitle = `${EXAM_CONFIG.examTitleBase} (${group})`;
        if (titleHeader) {
          titleHeader.textContent = currentExamTitle;
        }

        examActive = true;
        examSubmitted = false;
        violationCount = 0;

        logEvent("Exam started", `Group: ${group}, Name: ${fullName}`);

        if (!examDeadline) {
          examDeadline = Date.now() + EXAM_CONFIG.timeLimitMinutes * 60 * 1000;
          localStorage.setItem(DEADLINE_KEY, String(examDeadline));
          console.log("⏱ New examDeadline set:", new Date(examDeadline).toISOString());
        } else {
          console.log("⏱ Using existing examDeadline:", new Date(examDeadline).toISOString());
          if (Date.now() > examDeadline) {
            alert("Le délai de 60 minutes est écoulé. Vous ne pouvez plus commencer l'épreuve.");
            examActive = false;
            exam.style.display = "none";
            login.style.display = "block";
            return;
          }
        }

        isStartingExam = true;
        setTimeout(() => {
          isStartingExam = false;
          console.log("⏱ Startup grace period over");
        }, 1200);

        if (timerDisplay) {
          timerDisplay.style.display = "inline-block";
        }
        enableFullScreen();
        startTimer();
        randomizeQuestionOrder();
        randomizeSelectsKeepFirst();
        initDefinitionPreviews();
      }

      startBtn.addEventListener("click", () => {
        const firstName = (studentFirstNameInput.value || "").trim();
        const lastName = (studentLastNameInput.value || "").trim().toUpperCase();
        const email = (studentEmailInput.value || "").trim();
        const code = (classCodeInput.value || "").trim();
        const group = (groupSelect.value || "").trim();

        if (!firstName || !lastName || !email) {
          alert("Merci de remplir toutes les informations (nom, prénom et e-mail).");
          return;
        }

        if (!group) {
          alert("Merci de sélectionner votre groupe.");
          return;
        }

        const isDebug = code === EXAM_CONFIG.debugCode;
        const isRealClass = code === EXAM_CONFIG.classCode;

        if (!isDebug && !isRealClass) {
          alert("Code de classe invalide.");
          return;
        }

        const fullName = `${lastName} ${firstName}`;
        selectedGroup = group;

        confirmName.textContent = fullName;
        confirmEmail.textContent = email;
        confirmGroup.textContent = group;

        login.style.display = "none";
        confirmSec.style.display = "block";
      });

      confirmBackBtn.addEventListener("click", () => {
        confirmSec.style.display = "none";
        login.style.display = "block";
      });

      confirmBeginBtn.addEventListener("click", () => {
        beginExam();
      });

      toPartB.addEventListener("click", () => {
        partA.classList.remove("active");
        partB.classList.add("active");
        logEvent("Moved to Part B", "Student navigated from Part A to Part B");
        ensureQuill();
      });

      toPartA.addEventListener("click", () => {
        partB.classList.remove("active");
        partA.classList.add("active");
        logEvent("Returned to Part A", "Student navigated from Part B to Part A");
      });

      form.addEventListener("submit", e => {
        e.preventDefault();
        submitExam();
      });

      function submitExam(autoReason) {
        if (examSubmitted) return;
        examSubmitted = true;

        clearInterval(timer);

        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Envoi en cours…";
        }

        logEvent("Exam submitted", autoReason || "Student clicked submit");

        const fd = new FormData(form);
        const name = fd.get("studentName") || studentNameField.value;
        const email = fd.get("studentEmail") || studentEmailField.value;

        let minutesUsed = EXAM_CONFIG.timeLimitMinutes;
        if (examDeadline) {
          const remainingMs = examDeadline - Date.now();
          const remainingMin = Math.max(0, Math.floor(remainingMs / 60000));
          minutesUsed = EXAM_CONFIG.timeLimitMinutes - remainingMin;
        }

        const emailHtml = quill ? quill.root.innerHTML.trim() : "<em>(No response)</em>";
        const totalQs = document.querySelectorAll('#partA select[name^="q"]').length || 10;

        let scoreA = 0;
        let partARowsHTML = "";
        for (let i = 1; i <= totalQs; i++) {
          const sel = fd.get("q" + i) || "No answer";
          const corr = correctAnswers["q" + i] || "";
          const ok = sel === corr;
          if (ok) scoreA++;
          const mark = ok ? "✅ Correct" : `❌ Incorrect → Correct answer: ${corr}`;
          partARowsHTML += `
            <tr>
              <td style="padding:8px;border:1px solid #ccc;">${wordNames[i - 1] || ("Q" + i)}</td>
              <td style="padding:8px;border:1px solid #ccc;">${sel}</td>
              <td style="padding:8px;border:1px solid #ccc;color:${ok ? "green" : "#b00"};">${mark}</td>
            </tr>`;
        }

        const partBScore = "___ / 10";
        const finalNote = "___ / 20";
        const group = selectedGroup || groupNameField.value || EXAM_CONFIG.classLabel;

        let sessionLogHTML = "";
        if (sessionEvents.length > 0) {
          const rows = sessionEvents.map(ev => `
            <tr>
              <td style="padding:6px 8px;border:1px solid #ccc;">${ev.time}</td>
              <td style="padding:6px 8px;border:1px solid #ccc;">${ev.label}</td>
              <td style="padding:6px 8px;border:1px solid #ccc;">${ev.detail}</td>
            </tr>
          `).join("");

          sessionLogHTML = `
            <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">
            <h4 style="color:#004080;margin:10px 0 8px 0;">Exam session activity log</h4>
            <table style="border-collapse:collapse;width:100%;font-size:13px;">
              <thead>
                <tr style="background:#f3f4f6;color:#111827;text-align:left;">
                  <th style="padding:6px 8px;border:1px solid #ccc;">Time</th>
                  <th style="padding:6px 8px;border:1px solid #ccc;">Event</th>
                  <th style="padding:6px 8px;border:1px solid #ccc;">Details</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          `;
        } else {
          sessionLogHTML = `
            <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">
            <h4 style="color:#004080;margin:10px 0 8px 0;">Exam session activity log</h4>
            <p style="font-size:13px;color:#4b5563;margin:4px 0 0 0;">
              Aucun évènement particulier détecté pendant la session (pas de changement de fenêtre ou de sortie du plein écran).
            </p>
          `;
        }

        const htmlReport = `
          <h2 style="color:#004080;margin:0 0 8px 0;">
            Results – ${currentExamTitle} – ${name}
          </h2>
          <table style="border-collapse:collapse;width:100%;max-width:640px;font-size:14px;margin:0 0 12px 0;">
            <tr><td style="padding:4px 0;"><b>Student Name:</b> ${name}</td></tr>
            <tr><td style="padding:4px 0;"><b>Student Email:</b> ${email}</td></tr>
            <tr><td style="padding:4px 0;"><b>Group:</b> ${group}</td></tr>
            <tr><td style="padding:4px 0;"><b>Time Taken:</b> ${minutesUsed} min</td></tr>
          </table>
          <hr style="border:none;border-top:1px solid #ddd;margin:14px 0;">

          <h3 style="color:#004080;margin:10px 0 8px 0;">Part A – Vocabulary Matching</h3>
          <table style="border-collapse:collapse;width:100%;font-size:15px;margin-top:8px;">
            <thead>
              <tr style="background:#004080;color:#fff;text-align:left;">
                <th style="padding:8px;border:1px solid #ccc;">Word</th>
                <th style="padding:8px;border:1px solid #ccc;">Student Answer</th>
                <th style="padding:8px;border:1px solid #ccc;">Result</th>
              </tr>
            </thead>
            <tbody>
              ${partARowsHTML}
            </tbody>
          </table>
          <p style="margin:10px 0 0 0;"><b>Part A Score:</b> ${scoreA} / ${totalQs}</p>

          <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">

          <h3 style="color:#004080;margin:10px 0 8px 0;">Part B – Written Exercise</h3>
          <div style="border:1px solid #ccc;border-radius:6px;padding:10px;background:#f9f9f9;">
            ${emailHtml}
          </div>

          <table style="border-collapse:collapse;width:100%;font-size:15px;margin-top:6px;">
            <thead>
              <tr style="background:#004080;color:#fff;text-align:left;">
                <th style="padding:8px;border:1px solid #ccc;">Criterion</th>
                <th style="padding:8px;border:1px solid #ccc;">Maximum</th>
                <th style="padding:8px;border:1px solid #ccc;">Awarded</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding:8px;border:1px solid #ccc;">Vocabulary Use</td>
                <td style="padding:8px;border:1px solid #ccc;">/3</td>
                <td style="padding:8px;border:1px solid #ccc;">___ / 3</td>
              </tr>
              <tr>
                <td style="padding:8px;border:1px solid #ccc;">Structure &amp; Clarity</td>
                <td style="padding:8px;border:1px solid #ccc;">/3</td>
                <td style="padding:8px;border:1px solid #ccc;">___ / 3</td>
              </tr>
              <tr>
                <td style="padding:8px;border:1px solid #ccc;">Language Accuracy &amp; Tone</td>
                <td style="padding:8px;border:1px solid #ccc;">/2</td>
                <td style="padding:8px;border:1px solid #ccc;">___ / 2</td>
              </tr>
              <tr>
                <td style="padding:8px;border:1px solid #ccc;">Professional Style</td>
                <td style="padding:8px;border:1px solid #ccc;">/2</td>
                <td style="padding:8px;border:1px solid #ccc;">___ / 2</td>
              </tr>
            </tbody>
          </table>

          <h4 style="color:#004080;margin:12px 0 6px 0;">Instructor Comments:</h4>
          <div style="
            border:1px solid #d1d5db;
            border-radius:8px;
            padding:10px 12px;
            background:#f9fafb;
            font-size:14px;
            line-height:1.5;
          ">
            <!-- Write your comments here when correcting the exam -->
          </div>

          <p style="margin:12px 0 6px 0;"><b>Part B Score:</b> ${partBScore}</p>
          
          <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">

          <h4 style="color:#004080;margin:10px 0 8px 0;">Score Summary</h4>

          <table style="border-collapse:collapse;width:100%;max-width:460px;font-size:15px;">
            <tr>
              <td style="padding:8px;border:1px solid #ccc;">Part A Score</td>
              <td style="padding:8px;border:1px solid #ccc;">${scoreA} / ${totalQs}</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #ccc;">Part B Score</td>
              <td style="padding:8px;border:1px solid #ccc;">${partBScore}</td>
            </tr>
            <tr>
              <td style="padding:8px;border:1px solid #ccc;"><b>Final Note</b></td>
              <td style="padding:8px;border:1px solid #ccc;"><b>${finalNote}</b></td>
            </tr>
          </table>

          ${sessionLogHTML}

          <div style="border-top:1px solid #ccc;margin-top:16px;padding-top:8px;font-size:12px;color:#555;">
            <em>This report was generated automatically for the English Exam – Business Resources.</em>
          </div>
        `;

        const subject = EXAM_CONFIG.emailSubjectTemplate
          .replace("(NAME)", name)
          .replace("(GROUP)", group);

        if (window.emailjs) {
          emailjs
            .send(
              "service_opm4h6b",
              "template_r0u784p",
              {
                from_name: name,
                from_email: email,
                subject,
                message_html: htmlReport
              },
              "Bb0oPYBiZGQcyIz5r"
            )
            .then(() => {
              alert("✅ Épreuve envoyée avec succès.");
              localStorage.removeItem(DEADLINE_KEY);
              examDeadline = null;
              resetToLanding();
            })
            .catch(err => {
              alert(
                "❌ Erreur lors de l'envoi de l'épreuve : " +
                (err && err.text ? err.text : err)
              );
              console.error("EmailJS Error:", err);
              examSubmitted = false;
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = "Envoyer l'épreuve";
              }
            });
        } else {
          alert("EmailJS n'est pas chargé ; envoi simulé.");
          examSubmitted = false;
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Envoyer l'épreuve";
          }
        }
      }
    });
  </script>
</body>
</html>

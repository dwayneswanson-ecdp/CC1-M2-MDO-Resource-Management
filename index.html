



  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google" content="notranslate">
  <meta http-equiv="Content-Language" content="en">
  <meta name="robots" content="no-translate">
  <title>CC - English -</title>

  <!-- Quill CSS -->
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">

  <style>
    html, body { translate: none !important; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
    * { translate: none !important; }

    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #f8f9fb;
      margin: 0;
      color: #222;
      font-size: 16px;
      line-height: 1.6;
    }

    header {
      background: linear-gradient(135deg, #004080, #0066cc);
      color: #ffffff;
      padding: 25px 20px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    header h1 { margin: 0; font-size: 1.9em; letter-spacing: 0.5px; }
    #timer { text-align: right; font-weight: bold; margin-top: 10px; }

    main {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      padding: 40px;
      max-width: 520px;
      margin: 80px auto;
      text-align: left;
    }
    .card h2 { color: #004080; margin-top: 0; text-align: center; }

    label { display:block; margin: 12px 0 8px; font-weight: bold; }
    input[type="text"], input[type="email"], select {
      width: 100%; padding: 10px; border:1px solid #ccc; border-radius:6px;
    }
    textarea { width: 100%; padding: 10px; border:1px solid #ccc; border-radius:6px; }

    select {
      white-space: normal;
      word-wrap: break-word;
      padding: 8px;
    }

    button {
      background:#004080; color:#fff; border:none; padding:12px 28px;
      border-radius:6px; cursor:pointer; font-size:16px;
    }
    button:hover { background:#003666; }
    .btn-row { display:flex; gap:12px; flex-wrap: wrap; margin-top: 16px; }
    .btn-row.center { justify-content: center; }
    .btn-row.right { justify-content: flex-end; }
    .btn-light { background:#e9eef7; color:#004080; }
    .btn-light:hover { background:#dbe6f7; }

    ol { padding-left: 20px; }
    ol li { margin-bottom: 14px; }

    #exam, #confirm, #partA, #partB { display: none; }
    #partA.active, #partB.active { display: block; }

    .editor-card {
      border:1px solid #e3e6ee; border-radius:12px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.06);
    }
    .ql-toolbar.ql-snow { border:none; border-bottom:1px solid #e3e6ee; background:#f9fbff; }
    .ql-container.ql-snow { border:none; min-height: 260px; }
    .ql-editor { min-height: 240px; }
    .muted { color:#666; font-size: 14px; }
  /* ... your existing styles ... */

  .name-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .name-row .field {
    flex: 1 1 0;
  }

  /* visually force uppercase display on last name */
  .upper {
    text-transform: uppercase;
  }
  </style>



  <header>
    <h1>CC1 - English ‚Äî Resource Management (M2MDOG2)</h1>
    <div id="timer"></div>
  </header>

  <main>
        <!-- LOGIN -->
    <section id="login" class="card">
      <h2>Commencer l'√©preuve</h2>
      <p>Merci de renseigner vos informations pour commencer. Une fois l‚Äô√©preuve lanc√©e, vous disposerez de <b>40 minutes</b> pour la compl√©ter.</p>

      <label>Nom et pr√©nom :</label>
      <div class="name-row">
        <div class="field">
          <input type="text" id="studentLastName" class="upper" placeholder="NOM (en majuscules)" required>
        </div>
        <div class="field">
          <input type="text" id="studentFirstName" placeholder="Pr√©nom" required>
        </div>
      </div>

      <label>Adresse e-mail :</label>
      <input type="email" id="studentEmail" required>

      <label>Code de classe :</label>
      <input type="text" id="classCode" required>

      <div class="btn-row center">
        <button id="startBtn" type="button">Commencer</button>
      </div>
    </section>

    <!-- CONFIRM -->
    <section id="confirm" class="card">
      <h2>Veuillez confirmer vos informations</h2>
      <p><b>Nom &amp; pr√©nom :</b> <span id="confirmName"></span></p>
      <p><b>Email :</b> <span id="confirmEmail"></span></p>
      <p class="muted">
        Veuillez v√©rifier que ces informations sont correctes. Si quelque chose ne l‚Äôest pas, cliquez sur ¬´ Modifier ¬ª pour revenir √† l‚Äô√©cran pr√©c√©dent.
      </p>
      <div class="btn-row">
        <button type="button" class="btn-light" id="confirmBackBtn">‚Üê Modifier</button>
        <button type="button" id="confirmBeginBtn">Commencer l'√©preuve ‚Üí</button>
      </div>
    </section>

    <!-- EXAM -->
    <section id="exam">
      <form id="examForm">
        <input type="hidden" name="studentName" id="studentNameField">
        <input type="hidden" name="studentEmail" id="studentEmailField">
        <input type="hidden" name="classCode" id="classCodeField">

        <!-- PART A -->
        <div id="partA" class="active">
          <h2>Part A ‚Äì Vocabulary Matching</h2>
          <ol>
            <li>Budget
        <select name="q1">
          <option value="">-- Choose --</option><option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option><option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option><option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option><option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option><option>The total number of employees working in an organisation, department, or team.</option><option>The time between placing an order and receiving the product or service, including production and delivery.</option><option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option><option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option><option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option><option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
        </select>
      </li>
<li>Forecast
        <select name="q2">
          <option value="">-- Choose --</option><option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option><option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option><option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option><option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option><option>The total number of employees working in an organisation, department, or team.</option><option>The time between placing an order and receiving the product or service, including production and delivery.</option><option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option><option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option><option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option><option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
        </select>
      </li>
<li>KPI (Key Performance Indicator)
        <select name="q3">
          <option value="">-- Choose --</option><option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option><option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option><option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option><option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option><option>The total number of employees working in an organisation, department, or team.</option><option>The time between placing an order and receiving the product or service, including production and delivery.</option><option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option><option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option><option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option><option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
        </select>
      </li>
<li>Supplier
        <select name="q4">
          <option value="">-- Choose --</option><option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option><option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option><option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option><option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option><option>The total number of employees working in an organisation, department, or team.</option><option>The time between placing an order and receiving the product or service, including production and delivery.</option><option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option><option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option><option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option><option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
        </select>
      </li>
<li>Headcount
        <select name="q5">
          <option value="">-- Choose --</option><option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option><option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option><option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option><option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option><option>The total number of employees working in an organisation, department, or team.</option><option>The time between placing an order and receiving the product or service, including production and delivery.</option><option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option><option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option><option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option><option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
        </select>
      </li>
<li>Lead time
        <select name="q6">
          <option value="">-- Choose --</option><option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option><option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option><option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option><option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option><option>The total number of employees working in an organisation, department, or team.</option><option>The time between placing an order and receiving the product or service, including production and delivery.</option><option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option><option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option><option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option><option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
        </select>
      </li>
<li>Inventory
        <select name="q7">
          <option value="">-- Choose --</option><option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option><option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option><option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option><option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option><option>The total number of employees working in an organisation, department, or team.</option><option>The time between placing an order and receiving the product or service, including production and delivery.</option><option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option><option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option><option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option><option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
        </select>
      </li>
<li>Overhead
        <select name="q8">
          <option value="">-- Choose --</option><option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option><option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option><option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option><option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option><option>The total number of employees working in an organisation, department, or team.</option><option>The time between placing an order and receiving the product or service, including production and delivery.</option><option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option><option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option><option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option><option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
        </select>
      </li>
<li>Sustainability
        <select name="q9">
          <option value="">-- Choose --</option><option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option><option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option><option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option><option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option><option>The total number of employees working in an organisation, department, or team.</option><option>The time between placing an order and receiving the product or service, including production and delivery.</option><option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option><option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option><option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option><option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
        </select>
      </li>
<li>ROI (Return on Investment)
        <select name="q10">
          <option value="">-- Choose --</option><option>A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.</option><option>A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.</option><option>A measurable value that shows how effectively a company or team is achieving an important business objective.</option><option>A company or person that provides goods or services to another company, usually as part of a commercial contract.</option><option>The total number of employees working in an organisation, department, or team.</option><option>The time between placing an order and receiving the product or service, including production and delivery.</option><option>The stock of goods, materials, or products that a company holds for use in production or for sale to customers.</option><option>The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.</option><option>Doing business in a way that meets current needs without harming the environment, society, or future generations.</option><option>A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage.</option>
        </select>
      </li>
          </ol>
          <div class="btn-row right">
            <button type="button" id="toPartB">Next ‚Üí Part B</button>
          </div>
        </div>

        <!-- PART B -->
        <div id="partB">
          <h2>Part B ‚Äì Writing Task: Email to Your Manager</h2>

<p class="muted"><strong>Context</strong></p>
<p class="muted">
  In class, we discussed the business strategy of the sportswear brand <em>On</em>.
  The discussion focused on how the company uses its resources to support growth and remain competitive.
  During the session, you saw examples related to planning future performance, managing internal costs,
  and improving the way the company works with partners and customers. Your manager did not attend
  the presentation but wants to understand what you learned and how it could help the company.
</p>

<p class="muted"><strong>Task</strong></p>
<ul class="muted">
  <li>Explain what you understood about how the company is managing its resources.</li>
  <li>Analyse why this approach is important for long-term performance.</li>
  <li>Suggest 1‚Äì2 concrete actions you think a sportswear company should take to improve its strategy.</li>
</ul>

<p class="muted"><strong>Requirements</strong></p>
<ul class="muted">
  <li>Use at least THREE (3) words from the vocabulary discussed in class.</li>
  <li>
    Include a clear email structure:
    subject line; greeting / introduction; 2‚Äì3 short paragraphs presenting your ideas and examples;
    conclusion / closing sentence; appropriate sign-off (e.g. ‚ÄúBest regards,‚Äù + your name).
  </li>
  <li>Use formal, professional language.</li>
  <li>Write a coherent, well-organised email.</li>
</ul>

          <div class="editor-card">
            <div id="editor"></div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-light" id="toPartA">‚Üê Back to Part A</button>
            <button type="submit">Submit Exam</button>
          </div>
        </div>
      </form>
    </section>
  </main>

  <!-- JS at the end (load once) -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
   if (window.emailjs) {
  try {
    emailjs.init({
      publicKey: "Bb0oPYBiZGQcyIz5r",
    });
  } catch (e) {
    console.error("EmailJS init error:", e);
  }
}

    // Elements
    const login  = document.getElementById("login");
    const confirmSec = document.getElementById("confirm");
    const exam   = document.getElementById("exam");

    const startBtn = document.getElementById("startBtn");
    const confirmBackBtn  = document.getElementById("confirmBackBtn");
    const confirmBeginBtn = document.getElementById("confirmBeginBtn");

    const confirmName  = document.getElementById("confirmName");
    const confirmEmail = document.getElementById("confirmEmail");

    const partA = document.getElementById("partA");
    const partB = document.getElementById("partB");
    const toPartA = document.getElementById("toPartA");
    const toPartB = document.getElementById("toPartB");

    const timerDisplay = document.getElementById("timer");
    const form = document.getElementById("examForm");

    // NEW: name inputs
    const studentFirstNameInput = document.getElementById("studentFirstName");
    const studentLastNameInput  = document.getElementById("studentLastName");
    const studentEmailInput     = document.getElementById("studentEmail");
    const classCodeInput        = document.getElementById("classCode");

    // NEW: submit button (for disabling on send)
    const submitBtn = form ? form.querySelector('button[type="submit"]') : null;

    // Guard: if any required node missing, stop and log
    const required = [
      login, confirmSec, exam, startBtn, confirmBackBtn, confirmBeginBtn,
      confirmName, confirmEmail, partA, partB, toPartA, toPartB,
      timerDisplay, form, studentFirstNameInput, studentLastNameInput, studentEmailInput, classCodeInput
    ];
    if (required.some(n => !n)) {
      console.error("Missing required DOM nodes. Check IDs.", {
        login, confirmSec, exam, startBtn, confirmBackBtn, confirmBeginBtn,
        confirmName, confirmEmail, partA, partB, toPartA, toPartB,
        timerDisplay, form, studentFirstNameInput, studentLastNameInput, studentEmailInput, classCodeInput
      });
      return;
    }

    // Force LAST NAME to uppercase on input
    studentLastNameInput.addEventListener("input", () => {
      studentLastNameInput.value = studentLastNameInput.value.toUpperCase();
    });

   // Timer + persistent deadline across reloads
const DEADLINE_KEY = "examDeadline_M2MDOG2"; // change key per exam/page if needed
let examDeadline = null; // timestamp (ms)
let timer;

// On load, try to restore an existing deadline (if exam was started before)
const storedDeadline = localStorage.getItem(DEADLINE_KEY);
if (storedDeadline) {
  const parsed = parseInt(storedDeadline, 10);
  if (!Number.isNaN(parsed)) {
    examDeadline = parsed;
    console.log("‚è± Restored existing examDeadline from storage:", new Date(examDeadline).toISOString());
  }
}

    // NEW: flag to avoid duplicate submissions
    let examSubmitted = false;

    // Track whether the exam is currently active
let examActive = false;

    // Track whether we are in the brief "starting exam" phase
let isStartingExam = false;

    // If the page becomes hidden (changed tab, changed desktop, other app on top)
document.addEventListener("visibilitychange", () => {
  if (isStartingExam) {
    console.log("‚è± Ignoring visibilitychange during exam startup");
    return;
  }
  if (examActive && document.hidden) {
    terminateExam(
      "Vous avez quitt√© l'√©cran de l'√©preuve. L'√©preuve est termin√©e et doit √™tre recommenc√©e."
    );
  }
});

// If the window loses focus (clicked on another window/app)
window.addEventListener("blur", () => {
  if (isStartingExam) {
    console.log("‚è± Ignoring blur during exam startup");
    return;
  }
  if (examActive) {
    terminateExam(
      "Vous avez quitt√© la fen√™tre de l'√©preuve. L'√©preuve est termin√©e et doit √™tre recommenc√©e."
    );
  }
});

 document.addEventListener("fullscreenchange", () => {
  console.log("üì∫ fullscreenchange fired", {
    examActive,
    fullscreenElement: !!document.fullscreenElement
  });

  if (examActive && !document.fullscreenElement) {
    console.log("‚õî Leaving fullscreen while examActive ‚Üí terminateExam()");
    terminateExam("Vous avez quitt√© le mode plein √©cran. L'√©preuve est termin√©e et doit √™tre recommenc√©e.");
  }
});
    
    // Correct answers + word list (auto-filled)
 const correctAnswers = {
  q1: "A detailed financial plan that estimates how much money an organisation expects to earn and spend over a specific period.",
  q2: "A prediction of future results (such as sales, costs, or profits) based on current data, trends, and assumptions.",
  q3: "A measurable value that shows how effectively a company or team is achieving an important business objective.",
  q4: "A company or person that provides goods or services to another company, usually as part of a commercial contract.",
  q5: "The total number of employees working in an organisation, department, or team.",
  q6: "The time between placing an order and receiving the product or service, including production and delivery.",
  q7: "The stock of goods, materials, or products that a company holds for use in production or for sale to customers.",
  q8: "The ongoing business expenses that are not directly linked to producing a specific product or service, such as rent, utilities, or administration.",
  q9: "Doing business in a way that meets current needs without harming the environment, society, or future generations.",
  q10: "A measure that compares the profit gained from an investment to the amount of money invested, usually expressed as a percentage."
};

const wordNames = [
  "Budget",
  "Forecast",
  "KPI (Key Performance Indicator)",
  "Supplier",
  "Headcount",
  "Lead time",
  "Inventory",
  "Overhead",
  "Sustainability",
  "ROI (Return on Investment)"
];

// Lazy Quill
let quill = null;
function ensureQuill() {
  if (!quill) {
    quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold','italic','underline'],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['clean']
        ]
      }
    });

    // üîí Disable ALL right-click + context menu inside editor
    quill.root.addEventListener("contextmenu", (e) => {
      e.preventDefault();
    });

    // üîí Disable paste
    quill.root.addEventListener("paste", (e) => {
      e.preventDefault();
    });

    // üîí Disable copy
    quill.root.addEventListener("copy", (e) => {
      e.preventDefault();
    });

    // üîí Disable cut
    quill.root.addEventListener("cut", (e) => {
      e.preventDefault();
    });

    // üîí Disable drag & drop text into editor
    quill.root.addEventListener("drop", (e) => {
      e.preventDefault();
    });

    // üîí Disable copy/paste/cut/select-all via keyboard (Mac + Windows)
    quill.root.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && ["c", "v", "x", "a"].includes(e.key.toLowerCase())) {
        e.preventDefault();
      }
    });
  }
}
    
   function startTimer() {
  clearInterval(timer);

  timer = setInterval(() => {
    if (!examDeadline) return;

    const now = Date.now();
    const remainingMs = examDeadline - now;
    const totalSec = Math.max(0, Math.floor(remainingMs / 1000));
    const m = Math.floor(totalSec / 60);
    const s = totalSec % 60;

    timerDisplay.textContent = `Time Remaining: ${m}:${s.toString().padStart(2, "0")}`;

    if (remainingMs <= 0) {
      clearInterval(timer);
      // time is over ‚Üí force submission (or termination if you prefer)
      submitExam();
    }
  }, 1000);
}

function enableFullScreen() {
  if (document.documentElement.requestFullscreen) {
    document.documentElement.requestFullscreen().catch(() => {});
  }
}

function terminateExam(message) {
  console.log("üí£ terminateExam called", {
    message,
    examActiveBefore: examActive
  });

  // Stop the timer interval, but DO NOT touch examDeadline or localStorage
  try {
    clearInterval(timer);
  } catch (e) {
    console.error("Error clearing timer:", e);
  }

  // Flags: exam is no longer active, submission can be allowed again later
  examActive = false;
  examSubmitted = false;

  // Show the message (user clicks OK to continue)
  alert(
    message ||
      "Vous avez quitt√© l'√©cran de l'√©preuve. L'√©preuve est termin√©e et doit √™tre recommenc√©e."
  );

  // üîÅ Soft reset (fallback if reload is blocked)

  // Clear Part A + hidden fields
  if (form) {
    form.reset();
  }

  // Clear the Quill editor content (Part B)
  if (quill) {
    quill.setText(""); // fully blank
  }

  // Reset UI to login only
  if (exam) exam.style.display = "none";
  if (confirmSec) confirmSec.style.display = "none";
  if (login) login.style.display = "block";

  // Re-enable submit button if it was disabled
  if (submitBtn) {
    submitBtn.disabled = false;
    submitBtn.textContent = "Envoyer l'√©preuve";
  }

  console.log("‚úÖ Exam terminated; attempting hard reload‚Ä¶");

  // üîÑ Hard reload with a tiny delay
  try {
    setTimeout(() => {
      console.log("üîÅ Reloading page now‚Ä¶");
      // Do NOT clear localStorage deadline here ‚Äì we want to keep the 40-min window
      window.location.href = window.location.href; // equivalent to location.reload() but more explicit
    }, 150);
  } catch (e) {
    console.error("Reload failed:", e);
  }
}
    
    function randomizeSelectsKeepFirst() {
      document.querySelectorAll("#partA select").forEach(sel => {
        const opts = Array.from(sel.options);
        const first = opts.shift(); // remove first
        for (let i = opts.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [opts[i].text, opts[j].text] = [opts[j].text, opts[i].text];
        }
        sel.innerHTML = "";
        sel.appendChild(first);
        opts.forEach(o => sel.appendChild(o));
        sel.selectedIndex = 0;
      });
    }
function randomizeQuestionOrder() {
  const list = document.querySelector("#partA ol");
  if (!list) return;

  const items = Array.from(list.children);

  // Fisher‚ÄìYates shuffle
  for (let i = items.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [items[i], items[j]] = [items[j], items[i]];
  }

  // Re-append items in randomized order
  items.forEach(li => list.appendChild(li));
}
    
    // ----- Start ‚Üí Confirm -----
    startBtn.addEventListener("click", () => {
      const firstName = (studentFirstNameInput.value || "").trim();
      const lastName  = (studentLastNameInput.value || "").trim().toUpperCase();
      const email     = (studentEmailInput.value || "").trim();
      const code      = (classCodeInput.value || "").trim();

      if (!firstName || !lastName || !email) {
        alert("Merci de remplir toutes les informations (nom, pr√©nom et e-mail).");
        return;
      }
      if (code !== "BLANK") {
        alert("Code de classe invalide.");
        return;
      }

      const fullName = `${lastName} ${firstName}`;

      confirmName.textContent  = fullName;
      confirmEmail.textContent = email;

      // Move to Confirm page
      login.style.display = "none";
      confirmSec.style.display = "block";
    });

    // ----- Confirm page: begin exam -----
function beginExam() {
  // Get latest values
  const firstName = (studentFirstNameInput.value || "").trim();
  const lastName  = (studentLastNameInput.value || "").trim().toUpperCase();
  const email     = (studentEmailInput.value || "").trim();
  const code      = (classCodeInput.value || "").trim();

  const fullName = `${lastName} ${firstName}`;

  // Copy confirmed inputs into hidden fields
  document.getElementById("studentNameField").value  = fullName;
  document.getElementById("studentEmailField").value = email;
  document.getElementById("classCodeField").value    = code;

  // Show Part A
  confirmSec.style.display = "none";
  exam.style.display  = "block";
  partA.classList.add("active");
  partB.classList.remove("active");

  // Mark exam as active
  examActive = true;
  console.log("‚úÖ Exam started ‚Äì examActive =", examActive);

  // If this is the first time ever, set the deadline & persist it
  if (!examDeadline) {
    examDeadline = Date.now() + 40 * 60 * 1000;
    localStorage.setItem(DEADLINE_KEY, String(examDeadline));
    console.log("‚è± New examDeadline set:", new Date(examDeadline).toISOString());
  } else {
    console.log("‚è± Using existing examDeadline:", new Date(examDeadline).toISOString());
  }

  // If they try to start after the deadline, block it
  if (Date.now() > examDeadline) {
    alert(
      "Le d√©lai de 40 minutes est √©coul√©. Vous ne pouvez plus commencer ou reprendre l'√©preuve."
    );
    examActive = false;
    exam.style.display = "none";
    login.style.display = "block";
    return;
  }

  // üëâ Ignore blur/visibility for a very short startup window
  isStartingExam = true;
  setTimeout(() => {
    isStartingExam = false;
    console.log("‚è± Startup grace period over");
  }, 1200);

  // Anti-cheat & timer & shuffle
  enableFullScreen();
  startTimer();
  randomizeQuestionOrder();
  randomizeSelectsKeepFirst();
}

    // ----- Confirm page buttons -----
    confirmBackBtn.addEventListener("click", () => {
      confirmSec.style.display = "none";
      login.style.display = "block";
    });

    confirmBeginBtn.addEventListener("click", () => {
      beginExam();
    });

    // ----- Navigation Part A <-> Part B -----
    toPartB.addEventListener("click", () => {
      partA.classList.remove("active");
      partB.classList.add("active");
      ensureQuill();
    });
    toPartA.addEventListener("click", () => {
      partB.classList.remove("active");
      partA.classList.add("active");
    });

    // ----- Submit -----
    form.addEventListener("submit", e => {
      e.preventDefault();
      submitExam();
    });

    function submitExam() {
      // NEW: avoid duplicate submissions (user click + timer, double click, etc.)
      if (examSubmitted) {
        return;
      }
      examSubmitted = true;

      clearInterval(timer);

      // Disable submit button and show "sending" state
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "Envoi en cours‚Ä¶";
      }

      const fd = new FormData(form);
      const name  = fd.get("studentName")  || document.getElementById("studentNameField").value;
      const email = fd.get("studentEmail") || document.getElementById("studentEmailField").value;
      let minutesUsed = 40;
if (examDeadline) {
  const remainingMs = examDeadline - Date.now();
  const remainingMin = Math.max(0, Math.floor(remainingMs / 60000));
  minutesUsed = 40 - remainingMin;
}

      const emailHtml = quill ? quill.root.innerHTML.trim() : "<em>(No response)</em>";
      const totalQs = document.querySelectorAll('#partA select[name^="q"]').length || 10;

      let scoreA = 0;
      let partARowsHTML = "";
      for (let i = 1; i <= totalQs; i++) {
        const sel  = fd.get("q" + i) || "No answer";
        const corr = correctAnswers["q" + i] || "";
        const ok   = sel === corr;
        if (ok) scoreA++;
        const mark = ok ? "‚úÖ Correct" : `‚ùå Incorrect ‚Üí Correct answer: ${corr}`;
        partARowsHTML += `
          <tr>
            <td style="padding:8px;border:1px solid #ccc;">${wordNames[i-1] || ("Q"+i)}</td>
            <td style="padding:8px;border:1px solid #ccc;">${sel}</td>
            <td style="padding:8px;border:1px solid #ccc;color:${ok ? 'green' : '#b00'};">${mark}</td>
          </tr>`;
      }

      const partBScore = "___ / 10";
      const finalNote  = "___ / 20";

      const htmlReport = `
        <h2 style="color:#004080;margin:0 0 8px 0;">Results ‚Äì CC1 - English ‚Äì ${name} (M2 MDO G2)</h2>
        <table style="border-collapse:collapse;width:100%;max-width:640px;font-size:14px;margin:0 0 12px 0;">
          <tr><td style="padding:4px 0;"><b>Student Name:</b> ${name}</td></tr>
          <tr><td style="padding:4px 0;"><b>Student Email:</b> ${email}</td></tr>
          <tr><td style="padding:4px 0;"><b>Class Code:</b> M2MDOG2 </td></tr>
          <tr><td style="padding:4px 0;"><b>Time Taken:</b> ${minutesUsed} min</td></tr>
        </table>
        <hr style="border:none;border-top:1px solid #ddd;margin:14px 0;">

        <h3 style="color:#004080;margin:10px 0 8px 0;">Part A ‚Äì Vocabulary Matching</h3>
        <table style="border-collapse:collapse;width:100%;font-size:15px;margin-top:8px;">
          <thead>
            <tr style="background:#004080;color:#fff;text-align:left;">
              <th style="padding:8px;border:1px solid #ccc;">Word</th>
              <th style="padding:8px;border:1px solid #ccc;">Student Answer</th>
              <th style="padding:8px;border:1px solid #ccc;">Result</th>
            </tr>
          </thead>
          <tbody>
            ${partARowsHTML}
          </tbody>
        </table>
        <p style="margin:10px 0 0 0;"><b>Part A Score:</b> ${scoreA} / ${totalQs}</p>

        <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">

        <h3 style="color:#004080;margin:10px 0 8px 0;">Part B ‚Äì Written Exercise</h3>
        <div style="border:1px solid #ccc;border-radius:6px;padding:10px;background:#f9f9f9;">
          ${emailHtml}
        </div>

        <table style="border-collapse:collapse;width:100%;font-size:15px;margin-top:6px;">
          <thead>
            <tr style="background:#004080;color:#fff;text-align:left;">
              <th style="padding:8px;border:1px solid #ccc;">Criterion</th>
              <th style="padding:8px;border:1px solid #ccc;">Maximum</th>
              <th style="padding:8px;border:1px solid #ccc;">Awarded</th>
            </tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px;border:1px solid #ccc;">Vocabulary Use</td><td style="padding:8px;border:1px solid #ccc;">/3</td><td style="padding:8px;border:1px solid #ccc;">___ / 3</td></tr>
            <tr><td style="padding:8px;border:1px solid #ccc;">Structure & Clarity</td><td style="padding:8px;border:1px solid #ccc;">/3</td><td style="padding:8px;border:1px solid #ccc;">___ / 3</td></tr>
            <tr><td style="padding:8px;border:1px solid #ccc;">Language Accuracy & Tone</td><td style="padding:8px;border:1px solid #ccc;">/2</td><td style="padding:8px;border:1px solid #ccc;">___ / 2</td></tr>
            <tr><td style="padding:8px;border:1px solid #ccc;">Professional Style</td><td style="padding:8px;border:1px solid #ccc;">/2</td><td style="padding:8px;border:1px solid #ccc;">___ / 2</td></tr>
          </tbody>
        </table>
        <p style="margin:12px 0 6px 0;"><b>Instructor Comments:</b></p>
        <div style="border:1px solid #ccc;border-radius:6px;padding:10px;background:#fdfdfd;min-height:48px;">
          [Type feedback here]
        </div>
        <p style="margin:10px 0 0 0;"><b>Part B Score:</b> ${partBScore}</p>

        <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">

        <h4 style="color:#004080;margin:10px 0 8px 0;">Score Summary</h4>

        <table style="border-collapse:collapse;width:100%;max-width:460px;font-size:15px;">
          <tr>
            <td style="padding:8px;border:1px solid #ccc;">Part A Score</td>
            <td style="padding:8px;border:1px solid #ccc;">${scoreA} / ${totalQs}</td>
          </tr>
          <tr>
            <td style="padding:8px;border:1px solid #ccc;">Part B Score</td>
            <td style="padding:8px;border:1px solid #ccc;">${partBScore}</td>
          </tr>
          <tr>
            <td style="padding:8px;border:1px solid #ccc;"><b>Final Note</b></td>
            <td style="padding:8px;border:1px solid #ccc;"><b>${finalNote}</b></td>
          </tr>
        </table>

        <div style="border-top:1px solid #ccc;margin-top:16px;padding-top:8px;font-size:12px;color:#555;">
          <em>This report was generated automatically for the English Exam ‚Äì Business Resources.</em>
        </div>
      `;

      const subject = "(NAME) CC - English - M2 MDO G2".replace("(NAME)", name);

    if (window.emailjs) {
  emailjs
    .send(
      "service_opm4h6b",
      "template_r0u784p",
      {
        from_name: name,
        from_email: email,
        subject,
        message_html: htmlReport,
      },
      "Bb0oPYBiZGQcyIz5r" // public key again here
    )
    .then(() => {
  alert("‚úÖ √âpreuve envoy√©e avec succ√®s.");
  exam.style.display = "none";

  // Clean deadline for future sessions
  localStorage.removeItem(DEADLINE_KEY);
  examDeadline = null;
  examActive = false;
})
    .catch((err) => {
      alert(
        "‚ùå Erreur lors de l'envoi de l'√©preuve : " +
          (err && err.text ? err.text : err)
      );
      console.error("EmailJS Error:", err);
      examSubmitted = false;
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = "Envoyer l'√©preuve";
      }
    });
} else {
  alert("EmailJS n'est pas charg√© ; envoi simul√©.");
  examSubmitted = false;
  if (submitBtn) {
    submitBtn.disabled = false;
    submitBtn.textContent = "Envoyer l'√©preuve";
  }
}
    }
  });
</script>
